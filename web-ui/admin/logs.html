<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ­ã‚°ç®¡ç† - MCP-RS Web UI</title>
    <link rel="stylesheet" href="../shared/mcp-ui.css">
</head>
<body>
    <div class="mcp-container mcp-fade-in">
        <header class="mcp-header">
            <h1>ğŸ“‹ ãƒ­ã‚°ç®¡ç†</h1>
            <p>MCP-RSã‚µãƒ¼ãƒãƒ¼ã®ãƒ­ã‚°é–²è¦§ãƒ»ç®¡ç†ãƒ»åˆ†æ</p>
        </header>

        <nav class="mcp-nav">
            <ul>
                <li><a href="../index.html" id="nav-home">ğŸ  ãƒ›ãƒ¼ãƒ </a></li>
                <li><a href="../wordpress/dashboard.html" id="nav-wordpress">ğŸ”— WordPressç®¡ç†</a></li>
                <li><a href="config.html" id="nav-config">âš™ï¸ ã‚µãƒ¼ãƒãƒ¼è¨­å®š</a></li>
                <li><a href="transport.html" id="nav-transport">ğŸŒ Transportç®¡ç†</a></li>
                <li><a href="logs.html" id="nav-logs" class="active">ğŸ“‹ ãƒ­ã‚°ç®¡ç†</a></li>
            </ul>
        </nav>

        <main class="mcp-main">
            <!-- ãƒ­ã‚°çµ±è¨ˆ -->
            <div class="mcp-card">
                <h3>ğŸ“Š ãƒ­ã‚°çµ±è¨ˆ</h3>
                <div class="mcp-grid cols-4">
                    <div class="mcp-card">
                        <h4 style="color: #17a2b8;">ğŸ“ INFO</h4>
                        <div style="font-size: 2em; color: #17a2b8;"><strong id="info-count">1,247</strong></div>
                        <p style="margin: 5px 0 0 0; color: #6c757d;">24æ™‚é–“</p>
                    </div>
                    <div class="mcp-card">
                        <h4 style="color: #ffc107;">âš ï¸ WARN</h4>
                        <div style="font-size: 2em; color: #ffc107;"><strong id="warn-count">23</strong></div>
                        <p style="margin: 5px 0 0 0; color: #6c757d;">24æ™‚é–“</p>
                    </div>
                    <div class="mcp-card">
                        <h4 style="color: #dc3545;">âŒ ERROR</h4>
                        <div style="font-size: 2em; color: #dc3545;"><strong id="error-count">3</strong></div>
                        <p style="margin: 5px 0 0 0; color: #6c757d;">24æ™‚é–“</p>
                    </div>
                    <div class="mcp-card">
                        <h4 style="color: #6c757d;">ğŸ” DEBUG</h4>
                        <div style="font-size: 2em; color: #6c757d;"><strong id="debug-count">8,492</strong></div>
                        <p style="margin: 5px 0 0 0; color: #6c757d;">24æ™‚é–“</p>
                    </div>
                </div>
            </div>

            <div class="mcp-grid cols-3">
                <!-- ãƒ­ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»è¨­å®š -->
                <div class="mcp-card">
                    <h3>ğŸ” ãƒ­ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»è¨­å®š</h3>
                    
                    <div class="mb-2">
                        <h4>ğŸ“… æ™‚é–“ç¯„å›²</h4>
                        <label for="log-start-time"><strong>é–‹å§‹æ™‚åˆ»</strong></label>
                        <input type="datetime-local" class="mcp-input" id="log-start-time">
                        
                        <label for="log-end-time"><strong>çµ‚äº†æ™‚åˆ»</strong></label>
                        <input type="datetime-local" class="mcp-input" id="log-end-time">
                        
                        <div class="mcp-grid cols-3" style="margin-top: 10px;">
                            <button class="mcp-btn secondary" id="filter-1hour">1æ™‚é–“</button>
                            <button class="mcp-btn secondary" id="filter-24hours">24æ™‚é–“</button>
                            <button class="mcp-btn secondary" id="filter-7days">7æ—¥é–“</button>
                        </div>
                    </div>

                    <div class="mb-2">
                        <h4>ğŸ·ï¸ ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«</h4>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <label><input type="checkbox" id="level-trace"> TRACE</label>
                            <label><input type="checkbox" id="level-debug" checked> DEBUG</label>
                            <label><input type="checkbox" id="level-info" checked> INFO</label>
                            <label><input type="checkbox" id="level-warn" checked> WARN</label>
                            <label><input type="checkbox" id="level-error" checked> ERROR</label>
                        </div>
                        
                        <button class="mcp-btn secondary full-width" id="toggle-all-levels">
                            å…¨é¸æŠ/å…¨è§£é™¤
                        </button>
                    </div>

                    <div class="mb-2">
                        <h4>ğŸ” æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h4>
                        <label for="search-text"><strong>ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢</strong></label>
                        <input type="text" class="mcp-input" id="search-text" 
                               placeholder="ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¤œç´¢">
                        
                        <label for="filter-component"><strong>ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ</strong></label>
                        <select class="mcp-input" id="filter-component">
                            <option value="">ã™ã¹ã¦</option>
                            <option value="transport">Transport</option>
                            <option value="wordpress">WordPress</option>
                            <option value="config">Config</option>
                            <option value="security">Security</option>
                            <option value="plugin">Plugin</option>
                        </select>
                        
                        <button class="mcp-btn primary full-width" id="apply-filters">
                            ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
                        </button>
                        <button class="mcp-btn secondary full-width" id="clear-filters">
                            ğŸ—‘ï¸ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¯ãƒªã‚¢
                        </button>
                    </div>
                </div>

                <!-- ãƒ­ã‚°è¡¨ç¤ºãƒ»æ“ä½œ -->
                <div class="mcp-card" style="grid-column: span 2;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>ğŸ“‹ ãƒ­ã‚°è¡¨ç¤º</h3>
                        <div>
                            <button class="mcp-btn secondary" id="auto-refresh-toggle">
                                â° è‡ªå‹•æ›´æ–°: OFF
                            </button>
                            <button class="mcp-btn secondary" id="refresh-logs">
                                ğŸ”„ æ›´æ–°
                            </button>
                            <button class="mcp-btn primary" id="export-logs">
                                ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                            </button>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; height: 500px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.9em;">
                        <div id="log-display">
                            <div style="padding: 10px; color: #6c757d; text-align: center;">
                                ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="color: #6c757d;">
                            <span id="log-count">0</span> ã‚¨ãƒ³ãƒˆãƒªè¡¨ç¤ºä¸­ | 
                            æœ€çµ‚æ›´æ–°: <span id="last-update">--:--:--</span>
                        </div>
                        <div>
                            <button class="mcp-btn secondary" id="scroll-to-top">â¬†ï¸ æœ€ä¸Šéƒ¨</button>
                            <button class="mcp-btn secondary" id="scroll-to-bottom">â¬‡ï¸ æœ€ä¸‹éƒ¨</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç† -->
            <div class="mcp-card">
                <h3>ğŸ“ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†</h3>
                
                <div class="mcp-grid cols-2">
                    <div>
                        <h4>ğŸ“„ åˆ©ç”¨å¯èƒ½ãªãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«</h4>
                        <div id="log-files-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 6px; padding: 10px; background: #f8f9fa;">
                            <div style="display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #dee2e6;">
                                <span><strong>ğŸ“ mcp-rs.log</strong> (ç¾åœ¨)</span>
                                <span style="color: #28a745;">45.2 MB</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #dee2e6;">
                                <span>ğŸ“ mcp-rs.log.1</span>
                                <span style="color: #6c757d;">89.1 MB</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #dee2e6;">
                                <span>ğŸ“ mcp-rs.log.2</span>
                                <span style="color: #6c757d;">95.7 MB</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px;">
                                <span>ğŸ“ mcp-rs-error.log</span>
                                <span style="color: #dc3545;">1.2 MB</span>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <button class="mcp-btn secondary full-width mb-1" id="download-current-log">
                                ğŸ’¾ ç¾åœ¨ãƒ­ã‚°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                            </button>
                            <button class="mcp-btn secondary full-width mb-1" id="download-all-logs">
                                ğŸ“¦ å…¨ãƒ­ã‚°ã‚’ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                            </button>
                            <button class="mcp-btn warning full-width" id="rotate-logs">
                                ğŸ”„ ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
                            </button>
                        </div>
                    </div>

                    <div>
                        <h4>ğŸ—‘ï¸ ãƒ­ã‚°ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—</h4>
                        <div style="background: #fff3cd; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <h5 style="margin: 0 0 10px 0;">âš ï¸ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡</h5>
                            <div style="background: #e2e3e5; border-radius: 4px; height: 20px; position: relative;">
                                <div style="background: #ffc107; height: 20px; width: 68%; border-radius: 4px;"></div>
                                <span style="position: absolute; top: 2px; left: 50%; transform: translateX(-50%); font-size: 0.8em; font-weight: bold;">231MB / 340MB</span>
                            </div>
                            <p style="margin: 5px 0 0 0; font-size: 0.9em;">ä½¿ç”¨ç‡: 68% (è­¦å‘Šãƒ¬ãƒ™ãƒ«)</p>
                        </div>
                        
                        <label for="cleanup-days"><strong>ä¿æŒæœŸé–“ (æ—¥)</strong></label>
                        <input type="number" class="mcp-input" id="cleanup-days" 
                               value="30" min="1" max="365">
                        
                        <label for="max-file-size"><strong>æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º (MB)</strong></label>
                        <input type="number" class="mcp-input" id="max-file-size" 
                               value="100" min="1" max="1000">
                        
                        <button class="mcp-btn warning full-width mb-1" id="cleanup-old-logs">
                            ğŸ§¹ å¤ã„ãƒ­ã‚°ã‚’å‰Šé™¤
                        </button>
                        <button class="mcp-btn danger full-width" id="clear-all-logs">
                            ğŸ—‘ï¸ å…¨ãƒ­ã‚°å‰Šé™¤
                        </button>
                    </div>
                </div>
            </div>

            <!-- ãƒ­ã‚°åˆ†æ -->
            <div class="mcp-card">
                <h3>ğŸ“ˆ ãƒ­ã‚°åˆ†æ</h3>
                
                <div class="mcp-grid cols-2">
                    <div>
                        <h4>ğŸ” ã‚¨ãƒ©ãƒ¼åˆ†æ</h4>
                        <div id="error-analysis" style="background: #f8f9fa; padding: 15px; border-radius: 6px; min-height: 200px;">
                            <div style="margin-bottom: 15px;">
                                <h5>âŒ é »å‡ºã‚¨ãƒ©ãƒ¼ (24h)</h5>
                                <div style="padding: 8px; background: #fff; border-left: 3px solid #dc3545; margin: 5px 0;">
                                    <strong>Connection timeout</strong><br>
                                    <small>ç™ºç”Ÿå›æ•°: 8å› | æœ€çµ‚ç™ºç”Ÿ: 14:35</small>
                                </div>
                                <div style="padding: 8px; background: #fff; border-left: 3px solid #ffc107; margin: 5px 0;">
                                    <strong>Rate limit exceeded</strong><br>
                                    <small>ç™ºç”Ÿå›æ•°: 3å› | æœ€çµ‚ç™ºç”Ÿ: 12:22</small>
                                </div>
                            </div>
                            
                            <button class="mcp-btn secondary full-width" id="generate-error-report">
                                ğŸ“‹ ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
                            </button>
                        </div>
                    </div>

                    <div>
                        <h4>ğŸ“Š ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£åˆ†æ</h4>
                        <div id="activity-analysis" style="background: #f8f9fa; padding: 15px; border-radius: 6px; min-height: 200px;">
                            <div style="margin-bottom: 15px;">
                                <h5>ğŸš€ ãƒ”ãƒ¼ã‚¯æ™‚é–“å¸¯</h5>
                                <div style="display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #dee2e6;">
                                    <span>14:00 - 15:00</span>
                                    <strong style="color: #dc3545;">342 req/h</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #dee2e6;">
                                    <span>10:00 - 11:00</span>
                                    <strong style="color: #28a745;">287 req/h</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 5px;">
                                    <span>02:00 - 03:00</span>
                                    <strong style="color: #17a2b8;">15 req/h</strong>
                                </div>
                            </div>
                            
                            <button class="mcp-btn secondary full-width" id="generate-activity-report">
                                ğŸ“ˆ ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="mcp-footer">
            <p>
                ğŸš€ MCP-RS v0.16.0 - Log Management Console | 
                ğŸ’» é–‹ç™ºè€…: <strong>n-takatsu</strong> | 
                ğŸŒ <a href="https://github.com/n-takatsu/mcp-rs">GitHub</a>
            </p>
        </footer>
    </div>

    <script src="../shared/mcp-ui.js"></script>
    <script>
        class LogManager {
            constructor() {
                this.client = new MCPClient();
                this.logs = [];
                this.filteredLogs = [];
                this.autoRefreshInterval = null;
                this.autoRefreshEnabled = false;
                
                this.initializeElements();
                this.bindEvents();
                this.loadInitialLogs();
                this.setDefaultTimeRange();
            }

            initializeElements() {
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¦ç´ 
                this.startTimeInput = document.getElementById('log-start-time');
                this.endTimeInput = document.getElementById('log-end-time');
                this.searchTextInput = document.getElementById('search-text');
                this.componentFilter = document.getElementById('filter-component');

                // ãƒ¬ãƒ™ãƒ«ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
                this.levelCheckboxes = {
                    trace: document.getElementById('level-trace'),
                    debug: document.getElementById('level-debug'),
                    info: document.getElementById('level-info'),
                    warn: document.getElementById('level-warn'),
                    error: document.getElementById('level-error')
                };

                // ãƒ­ã‚°è¡¨ç¤ºè¦ç´ 
                this.logDisplay = document.getElementById('log-display');
                this.logCountSpan = document.getElementById('log-count');
                this.lastUpdateSpan = document.getElementById('last-update');

                // ãƒœã‚¿ãƒ³è¦ç´ 
                this.autoRefreshBtn = document.getElementById('auto-refresh-toggle');

                // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
                MCPUIComponents.setActiveNav('nav-logs');
            }

            bindEvents() {
                // æ™‚é–“ç¯„å›²ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
                document.getElementById('filter-1hour').addEventListener('click', () => this.setTimeRange(1));
                document.getElementById('filter-24hours').addEventListener('click', () => this.setTimeRange(24));
                document.getElementById('filter-7days').addEventListener('click', () => this.setTimeRange(24 * 7));

                // ãƒ¬ãƒ™ãƒ«é¸æŠ
                document.getElementById('toggle-all-levels').addEventListener('click', () => this.toggleAllLevels());

                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ“ä½œ
                document.getElementById('apply-filters').addEventListener('click', () => this.applyFilters());
                document.getElementById('clear-filters').addEventListener('click', () => this.clearFilters());

                // ãƒ­ã‚°è¡¨ç¤ºæ“ä½œ
                document.getElementById('auto-refresh-toggle').addEventListener('click', () => this.toggleAutoRefresh());
                document.getElementById('refresh-logs').addEventListener('click', () => this.refreshLogs());
                document.getElementById('export-logs').addEventListener('click', () => this.exportLogs());

                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ“ä½œ
                document.getElementById('scroll-to-top').addEventListener('click', () => {
                    this.logDisplay.scrollTop = 0;
                });
                document.getElementById('scroll-to-bottom').addEventListener('click', () => {
                    this.logDisplay.scrollTop = this.logDisplay.scrollHeight;
                });

                // ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†
                document.getElementById('download-current-log').addEventListener('click', () => this.downloadCurrentLog());
                document.getElementById('download-all-logs').addEventListener('click', () => this.downloadAllLogs());
                document.getElementById('rotate-logs').addEventListener('click', () => this.rotateLogs());
                document.getElementById('cleanup-old-logs').addEventListener('click', () => this.cleanupOldLogs());
                document.getElementById('clear-all-logs').addEventListener('click', () => this.clearAllLogs());

                // ãƒ­ã‚°åˆ†æ
                document.getElementById('generate-error-report').addEventListener('click', () => this.generateErrorReport());
                document.getElementById('generate-activity-report').addEventListener('click', () => this.generateActivityReport());

                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œç´¢
                this.searchTextInput.addEventListener('input', () => {
                    clearTimeout(this.searchTimeout);
                    this.searchTimeout = setTimeout(() => this.applyFilters(), 500);
                });
            }

            setDefaultTimeRange() {
                const now = new Date();
                const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                
                this.endTimeInput.value = now.toISOString().slice(0, 16);
                this.startTimeInput.value = oneDayAgo.toISOString().slice(0, 16);
            }

            setTimeRange(hours) {
                const now = new Date();
                const pastTime = new Date(now.getTime() - hours * 60 * 60 * 1000);
                
                this.endTimeInput.value = now.toISOString().slice(0, 16);
                this.startTimeInput.value = pastTime.toISOString().slice(0, 16);
                
                this.applyFilters();
            }

            toggleAllLevels() {
                const allChecked = Object.values(this.levelCheckboxes).every(cb => cb.checked);
                
                Object.values(this.levelCheckboxes).forEach(checkbox => {
                    checkbox.checked = !allChecked;
                });
                
                this.applyFilters();
            }

            async loadInitialLogs() {
                try {
                    // ãƒ¢ãƒƒã‚¯ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
                    this.logs = this.generateMockLogs();
                    this.applyFilters();
                    this.updateLogStats();
                } catch (error) {
                    console.error('ãƒ­ã‚°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    this.logDisplay.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #dc3545;">
                            <p>âŒ ãƒ­ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            }

            generateMockLogs() {
                const levels = ['TRACE', 'DEBUG', 'INFO', 'WARN', 'ERROR'];
                const components = ['transport', 'wordpress', 'config', 'security', 'plugin'];
                const messages = [
                    'Connection established successfully',
                    'Configuration loaded from file',
                    'WordPress API request processed',
                    'Rate limit check passed',
                    'Plugin loaded successfully',
                    'Authentication completed',
                    'Database connection established',
                    'Cache miss for key: user_123',
                    'Transport switching completed',
                    'Security policy applied',
                    'Connection timeout occurred',
                    'Invalid API key provided',
                    'Memory usage threshold exceeded'
                ];

                const logs = [];
                const now = new Date();

                for (let i = 0; i < 1000; i++) {
                    const timestamp = new Date(now.getTime() - Math.random() * 7 * 24 * 60 * 60 * 1000);
                    const level = levels[Math.floor(Math.random() * levels.length)];
                    const component = components[Math.floor(Math.random() * components.length)];
                    const message = messages[Math.floor(Math.random() * messages.length)];
                    
                    logs.push({
                        timestamp: timestamp.toISOString(),
                        level: level,
                        component: component,
                        message: `${message} [${component}:${Math.floor(Math.random() * 1000)}]`,
                        raw: `${timestamp.toISOString()} [${level}] ${component}: ${message}`
                    });
                }

                return logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            }

            applyFilters() {
                const startTime = new Date(this.startTimeInput.value);
                const endTime = new Date(this.endTimeInput.value);
                const searchText = this.searchTextInput.value.toLowerCase();
                const component = this.componentFilter.value;
                
                const selectedLevels = Object.entries(this.levelCheckboxes)
                    .filter(([level, checkbox]) => checkbox.checked)
                    .map(([level]) => level.toUpperCase());

                this.filteredLogs = this.logs.filter(log => {
                    const logTime = new Date(log.timestamp);
                    
                    // æ™‚é–“ç¯„å›²ãƒã‚§ãƒƒã‚¯
                    if (logTime < startTime || logTime > endTime) return false;
                    
                    // ãƒ¬ãƒ™ãƒ«ãƒã‚§ãƒƒã‚¯
                    if (!selectedLevels.includes(log.level)) return false;
                    
                    // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
                    if (component && log.component !== component) return false;
                    
                    // ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢
                    if (searchText && !log.message.toLowerCase().includes(searchText)) return false;
                    
                    return true;
                });

                this.displayLogs();
                this.updateLogCount();
            }

            displayLogs() {
                if (this.filteredLogs.length === 0) {
                    this.logDisplay.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #6c757d;">
                            <p>ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                    `;
                    return;
                }

                const logsToShow = this.filteredLogs.slice(0, 500); // æœ€å¤§500ä»¶è¡¨ç¤º
                
                this.logDisplay.innerHTML = logsToShow.map(log => {
                    const levelColor = this.getLevelColor(log.level);
                    const timestamp = new Date(log.timestamp).toLocaleString('ja-JP');
                    
                    return `
                        <div style="padding: 5px 10px; border-bottom: 1px solid #e9ecef; font-size: 0.85em; line-height: 1.4;">
                            <span style="color: #6c757d;">${timestamp}</span>
                            <span style="color: ${levelColor}; font-weight: bold; margin: 0 10px;">[${log.level}]</span>
                            <span style="color: #17a2b8; font-weight: bold;">${log.component}:</span>
                            <span>${log.message}</span>
                        </div>
                    `;
                }).join('');

                // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã«
                this.logDisplay.scrollTop = this.logDisplay.scrollHeight;
            }

            getLevelColor(level) {
                const colors = {
                    'TRACE': '#6c757d',
                    'DEBUG': '#6c757d',
                    'INFO': '#17a2b8',
                    'WARN': '#ffc107',
                    'ERROR': '#dc3545'
                };
                return colors[level] || '#6c757d';
            }

            updateLogCount() {
                this.logCountSpan.textContent = this.filteredLogs.length.toLocaleString();
                this.lastUpdateSpan.textContent = new Date().toLocaleTimeString('ja-JP');
            }

            updateLogStats() {
                // 24æ™‚é–“ä»¥å†…ã®ãƒ­ã‚°çµ±è¨ˆã‚’è¨ˆç®—
                const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
                const recent24h = this.logs.filter(log => new Date(log.timestamp) > oneDayAgo);
                
                const stats = {
                    INFO: recent24h.filter(log => log.level === 'INFO').length,
                    WARN: recent24h.filter(log => log.level === 'WARN').length,
                    ERROR: recent24h.filter(log => log.level === 'ERROR').length,
                    DEBUG: recent24h.filter(log => log.level === 'DEBUG').length
                };

                document.getElementById('info-count').textContent = stats.INFO.toLocaleString();
                document.getElementById('warn-count').textContent = stats.WARN.toLocaleString();
                document.getElementById('error-count').textContent = stats.ERROR.toLocaleString();
                document.getElementById('debug-count').textContent = stats.DEBUG.toLocaleString();
            }

            clearFilters() {
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢
                this.searchTextInput.value = '';
                this.componentFilter.value = '';
                
                // ã™ã¹ã¦ã®ãƒ¬ãƒ™ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
                Object.values(this.levelCheckboxes).forEach(checkbox => {
                    checkbox.checked = true;
                });
                
                // æ™‚é–“ç¯„å›²ã‚’24æ™‚é–“ã«è¨­å®š
                this.setTimeRange(24);
            }

            toggleAutoRefresh() {
                this.autoRefreshEnabled = !this.autoRefreshEnabled;
                
                if (this.autoRefreshEnabled) {
                    this.autoRefreshBtn.textContent = 'â° è‡ªå‹•æ›´æ–°: ON';
                    this.autoRefreshBtn.className = 'mcp-btn primary';
                    this.autoRefreshInterval = setInterval(() => {
                        this.refreshLogs();
                    }, 5000); // 5ç§’é–“éš”
                } else {
                    this.autoRefreshBtn.textContent = 'â° è‡ªå‹•æ›´æ–°: OFF';
                    this.autoRefreshBtn.className = 'mcp-btn secondary';
                    if (this.autoRefreshInterval) {
                        clearInterval(this.autoRefreshInterval);
                        this.autoRefreshInterval = null;
                    }
                }
            }

            async refreshLogs() {
                try {
                    // æ–°ã—ã„ãƒ­ã‚°ã‚’è¿½åŠ ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰
                    const newLogs = this.generateMockLogs().slice(0, 10);
                    this.logs = newLogs.concat(this.logs).slice(0, 2000); // æœ€å¤§2000ä»¶ä¿æŒ
                    
                    this.applyFilters();
                    this.updateLogStats();
                    
                    if (!this.autoRefreshEnabled) {
                        MCPUIComponents.showToast('âœ… ãƒ­ã‚°ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ', 'success');
                    }
                } catch (error) {
                    MCPUIComponents.showToast('âŒ ãƒ­ã‚°æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            }

            exportLogs() {
                try {
                    const exportData = this.filteredLogs.map(log => 
                        `${log.timestamp}\t${log.level}\t${log.component}\t${log.message}`
                    ).join('\n');
                    
                    const blob = new Blob([exportData], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    a.href = url;
                    a.download = `mcp-rs-logs-${timestamp}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    MCPUIComponents.showToast('ğŸ“¤ ãƒ­ã‚°ãŒã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚Œã¾ã—ãŸ', 'success');
                } catch (error) {
                    MCPUIComponents.showToast('âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            }

            downloadCurrentLog() {
                MCPUIComponents.showModal(
                    'ğŸ’¾ ç¾åœ¨ãƒ­ã‚°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰',
                    '<p>ç¾åœ¨ã®ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ« (mcp-rs.log) ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ</p><p><strong>ã‚µã‚¤ã‚º:</strong> 45.2 MB</p>',
                    [
                        { 
                            text: 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰', 
                            type: 'primary',
                            onclick: 'this.closest(\'.modal\').remove(); window.logManager.executeDownload(\"current\");'
                        },
                        { text: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', type: 'secondary' }
                    ]
                );
            }

            downloadAllLogs() {
                MCPUIComponents.showModal(
                    'ğŸ“¦ å…¨ãƒ­ã‚°ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰',
                    '<p>ã™ã¹ã¦ã®ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ZIPã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ</p><p><strong>ç·ã‚µã‚¤ã‚º:</strong> 231 MB</p>',
                    [
                        { 
                            text: 'ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰', 
                            type: 'primary',
                            onclick: 'this.closest(\'.modal\').remove(); window.logManager.executeDownload(\"all\");'
                        },
                        { text: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', type: 'secondary' }
                    ]
                );
            }

            executeDownload(type) {
                MCPUIComponents.showToast(
                    type === 'current' ? 'ğŸ’¾ ç¾åœ¨ãƒ­ã‚°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...' : 'ğŸ“¦ å…¨ãƒ­ã‚°ZIPã‚’ä½œæˆä¸­...',
                    'info'
                );
                
                setTimeout(() => {
                    MCPUIComponents.showToast(
                        type === 'current' ? 'âœ… ãƒ­ã‚°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†' : 'âœ… ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†',
                        'success'
                    );
                }, 2000);
            }

            rotateLogs() {
                MCPUIComponents.showModal(
                    'ğŸ”„ ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ',
                    '<p>ç¾åœ¨ã®ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¾ã™ã‹ï¼Ÿ</p><p>ç¾åœ¨ã®ãƒ­ã‚°ã¯ .1 ã«ç§»å‹•ã•ã‚Œã€æ–°ã—ã„ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã™ã€‚</p>',
                    [
                        { 
                            text: 'ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ', 
                            type: 'warning',
                            onclick: 'this.closest(\'.modal\').remove(); window.logManager.executeRotation();'
                        },
                        { text: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', type: 'secondary' }
                    ]
                );
            }

            executeRotation() {
                MCPUIComponents.showToast('ğŸ”„ ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œä¸­...', 'info');
                
                setTimeout(() => {
                    MCPUIComponents.showToast('âœ… ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†', 'success');
                }, 1500);
            }

            cleanupOldLogs() {
                const days = parseInt(document.getElementById('cleanup-days').value);
                
                MCPUIComponents.showModal(
                    'ğŸ§¹ å¤ã„ãƒ­ã‚°å‰Šé™¤',
                    `<p>${days}æ—¥ã‚ˆã‚Šå¤ã„ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p><p><strong>âš ï¸ è­¦å‘Š:</strong> å‰Šé™¤ã•ã‚ŒãŸãƒ­ã‚°ã¯å¾©å…ƒã§ãã¾ã›ã‚“ã€‚</p>`,
                    [
                        { 
                            text: 'å‰Šé™¤å®Ÿè¡Œ', 
                            type: 'danger',
                            onclick: 'this.closest(\'.modal\').remove(); window.logManager.executeCleanup();'
                        },
                        { text: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', type: 'secondary' }
                    ]
                );
            }

            executeCleanup() {
                MCPUIComponents.showToast('ğŸ§¹ å¤ã„ãƒ­ã‚°ã‚’å‰Šé™¤ä¸­...', 'info');
                
                setTimeout(() => {
                    MCPUIComponents.showToast('âœ… ãƒ­ã‚°ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†', 'success');
                }, 1500);
            }

            clearAllLogs() {
                MCPUIComponents.showModal(
                    'ğŸ—‘ï¸ å…¨ãƒ­ã‚°å‰Šé™¤',
                    '<p><strong>âš ï¸ å±é™º:</strong> ã™ã¹ã¦ã®ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚</p><p>ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ</p>',
                    [
                        { 
                            text: 'å…¨å‰Šé™¤å®Ÿè¡Œ', 
                            type: 'danger',
                            onclick: 'this.closest(\'.modal\').remove(); window.logManager.executeClearAll();'
                        },
                        { text: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', type: 'secondary' }
                    ]
                );
            }

            executeClearAll() {
                MCPUIComponents.showToast('ğŸ—‘ï¸ å…¨ãƒ­ã‚°ã‚’å‰Šé™¤ä¸­...', 'warning');
                
                setTimeout(() => {
                    MCPUIComponents.showToast('âš ï¸ å…¨ãƒ­ã‚°å‰Šé™¤å®Œäº†', 'warning');
                    // ãƒ­ã‚°è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
                    this.logs = [];
                    this.filteredLogs = [];
                    this.displayLogs();
                    this.updateLogStats();
                }, 2000);
            }

            generateErrorReport() {
                MCPUIComponents.showModal(
                    'ğŸ“‹ ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ',
                    `<div style="font-family: 'Courier New', monospace; font-size: 0.9em; max-height: 400px; overflow-y: auto;">
                       <h4>ğŸ“Š ã‚¨ãƒ©ãƒ¼åˆ†æãƒ¬ãƒãƒ¼ãƒˆ</h4>
                       <p><strong>æœŸé–“:</strong> éå»24æ™‚é–“</p>
                       <p><strong>ç·ã‚¨ãƒ©ãƒ¼æ•°:</strong> 3ä»¶</p>
                       
                       <h5>âŒ ã‚¨ãƒ©ãƒ¼è©³ç´°</h5>
                       <div style="background: #f8f9fa; padding: 10px; margin: 10px 0; border-left: 3px solid #dc3545;">
                         <strong>Connection timeout</strong><br>
                         ç™ºç”Ÿå›æ•°: 2å›<br>
                         æœ€åˆã®ç™ºç”Ÿ: 2025-11-09 12:34:56<br>
                         æœ€å¾Œã®ç™ºç”Ÿ: 2025-11-09 14:35:12<br>
                         å½±éŸ¿ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: transport
                       </div>
                       
                       <div style="background: #f8f9fa; padding: 10px; margin: 10px 0; border-left: 3px solid #dc3545;">
                         <strong>Invalid API key</strong><br>
                         ç™ºç”Ÿå›æ•°: 1å›<br>
                         ç™ºç”Ÿæ™‚åˆ»: 2025-11-09 16:22:45<br>
                         å½±éŸ¿ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: wordpress
                       </div>
                       
                       <h5>ğŸ’¡ æ¨å¥¨å¯¾å‡¦æ³•</h5>
                       <ul>
                         <li>Connection timeout: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šã‚’ç¢ºèª</li>
                         <li>Invalid API key: WordPressèªè¨¼æƒ…å ±ã‚’æ›´æ–°</li>
                       </ul>
                     </div>`,
                    [{ text: 'é–‰ã˜ã‚‹', type: 'primary' }]
                );
            }

            generateActivityReport() {
                MCPUIComponents.showModal(
                    'ğŸ“ˆ ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆ',
                    `<div style="font-family: 'Courier New', monospace; font-size: 0.9em; max-height: 400px; overflow-y: auto;">
                       <h4>ğŸ“Š ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£åˆ†æãƒ¬ãƒãƒ¼ãƒˆ</h4>
                       <p><strong>æœŸé–“:</strong> éå»24æ™‚é–“</p>
                       <p><strong>ç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°:</strong> 1,247ä»¶</p>
                       
                       <h5>ğŸ• æ™‚é–“åˆ¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°</h5>
                       <div style="background: #f8f9fa; padding: 10px; margin: 10px 0;">
                         00:00-01:00: â–ˆâ–ˆâ–ˆâ–ˆ 23<br>
                         01:00-02:00: â–ˆâ–ˆ 8<br>
                         02:00-03:00: â–ˆ 5<br>
                         ...<br>
                         14:00-15:00: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 342 (ãƒ”ãƒ¼ã‚¯)<br>
                         15:00-16:00: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 298<br>
                         ...<br>
                         23:00-00:00: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 45
                       </div>
                       
                       <h5>ğŸ¯ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ¥çµ±è¨ˆ</h5>
                       <div style="background: #f8f9fa; padding: 10px; margin: 10px 0;">
                         transport: 456ä»¶ (36.6%)<br>
                         wordpress: 423ä»¶ (33.9%)<br>
                         config: 198ä»¶ (15.9%)<br>
                         security: 123ä»¶ (9.9%)<br>
                         plugin: 47ä»¶ (3.7%)
                       </div>
                     </div>`,
                    [{ text: 'é–‰ã˜ã‚‹', type: 'primary' }]
                );
            }
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            window.logManager = new LogManager();
        });
    </script>
</body>
</html>