# CVE Provider Documentation

## 概要

CVEプロバイダーは、NVD (National Vulnerability Database) のCVE APIと統合し、既知の脆弱性情報を検索・評価します。

## 特徴

- ✅ **CVE ID検索**: 特定のCVE IDで脆弱性情報を取得
- ✅ **キーワード検索**: 製品名やキーワードでCVEを検索
- ✅ **CVSS スコアリング**: 自動的な深刻度評価（v3.1/v3.0/v2.0対応）
- ✅ **キャッシング**: 24時間のキャッシュでAPI呼び出しを削減
- ✅ **レート制限管理**: NVDのレート制限を自動遵守
- ✅ **詳細な脆弱性情報**: 説明、影響製品、参照リンク等
- ✅ **複数CVSS バージョン対応**: CVSS v2.0, v3.0, v3.1

## セットアップ

### 1. APIキーについて

NVD APIは**APIキー不要**で利用可能ですが、レート制限があります：

- **APIキーなし**: 5リクエスト/30秒
- **APIキーあり**: 50リクエスト/30秒

APIキーを取得する場合：
1. [NVD API](https://nvd.nist.gov/developers/request-an-api-key)でリクエスト
2. 環境変数に設定（オプション）:

```powershell
# PowerShell (APIキーを使用する場合)
$env:NVD_API_KEY="your_api_key_here"
```

### 2. プロバイダーの初期化

```rust
use mcp_rs::threat_intelligence::providers::{CVEProvider, ThreatProvider};
use mcp_rs::threat_intelligence::types::ProviderConfig;
use std::collections::HashMap;

let config = ProviderConfig {
    name: "CVE".to_string(),
    enabled: true,
    api_key: String::new(), // APIキー不要（または環境変数から取得）
    base_url: "https://services.nvd.nist.gov/rest/json".to_string(),
    timeout_seconds: 30,    // NVDは応答が遅い場合があるため長めに
    rate_limit_per_minute: 10, // 5リクエスト/30秒 = 10リクエスト/分
    reliability_factor: 0.98,  // NVDは信頼性が高い
    provider_specific: HashMap::new(),
};

let provider = CVEProvider::new(config)?;
```

## 使用例

### CVE IDで検索

```rust
use mcp_rs::threat_intelligence::types::{IndicatorType, ThreatIndicator};

// Log4Shell脆弱性を検索
let indicator = ThreatIndicator {
    indicator_type: IndicatorType::FileHash,
    value: "CVE-2021-44228".to_string(),
    pattern: None,
    tags: Vec::new(),
    context: Some("Log4Shell vulnerability".to_string()),
    first_seen: chrono::Utc::now(),
};

match provider.check_indicator(&indicator).await {
    Ok(threats) => {
        for threat in threats {
            println!("CVE: {:?}", threat.metadata.cve_references);
            println!("Severity: {:?}", threat.severity);
            println!("CVSS Score: {:?}", 
                threat.metadata.custom_attributes.get("cvss_score"));
            println!("Description: {:?}", threat.metadata.description);
        }
    }
    Err(e) => eprintln!("Error: {}", e),
}
```

### キーワード検索

```rust
// Apacheに関連するCVEを検索
let indicator = ThreatIndicator {
    indicator_type: IndicatorType::Domain, // 任意のタイプでOK
    value: "apache struts".to_string(),
    pattern: None,
    tags: Vec::new(),
    context: None,
    first_seen: chrono::Utc::now(),
};

let threats = provider.check_indicator(&indicator).await?;
println!("Found {} CVEs related to Apache Struts", threats.len());
```

### バッチ検索

```rust
let cve_ids = ["CVE-2021-44228", "CVE-2014-0160", "CVE-2017-5638"];

let indicators: Vec<ThreatIndicator> = cve_ids
    .iter()
    .map(|cve| ThreatIndicator {
        indicator_type: IndicatorType::FileHash,
        value: cve.to_string(),
        pattern: None,
        tags: Vec::new(),
        context: None,
        first_seen: chrono::Utc::now(),
    })
    .collect();

let threats = provider.batch_check_indicators(&indicators).await?;
println!("Total CVEs retrieved: {}", threats.len());
```

### キャッシュ管理

```rust
// キャッシュサイズ確認
let cache_size = provider.cache_size().await;
println!("Cached entries: {}", cache_size);

// キャッシュクリア
provider.clear_cache().await;
```

## CVE情報の詳細

### 取得できる情報

- **CVE ID**: 例: CVE-2021-44228
- **公開日**: 脆弱性が最初に公開された日時
- **最終更新日**: 情報が最後に更新された日時
- **説明**: 脆弱性の詳細説明
- **CVSS スコア**: 0.0-10.0の評価値
- **CVSS ベクター**: 詳細な評価基準（例: CVSS:3.1/AV:N/AC:L/...）
- **深刻度**: Critical/High/Medium/Low/Info
- **影響を受ける製品**: CPE (Common Platform Enumeration) 形式
- **参照リンク**: 関連する技術記事やパッチ情報

### 深刻度マッピング

CVSS スコアから深刻度レベルを自動判定：

| CVSS Score | 深刻度レベル |
|------------|-------------|
| 9.0-10.0   | Critical    |
| 7.0-8.9    | High        |
| 4.0-6.9    | Medium      |
| 0.1-3.9    | Low         |
| 0.0        | Info        |

### CVSS バージョン優先順位

複数のCVSSバージョンが存在する場合、以下の優先順位で選択：

1. **CVSS v3.1** (最新、推奨)
2. **CVSS v3.0**
3. **CVSS v2.0** (レガシー)

## レート制限

### 無料アクセス（APIキーなし）

- **制限**: 5リクエスト/30秒
- **推奨設定**: `rate_limit_per_minute: 10`
- **用途**: 小規模な検索、テスト

### APIキー使用時

- **制限**: 50リクエスト/30秒  
- **推奨設定**: `rate_limit_per_minute: 100`
- **用途**: 本番環境、大規模検索

### レート制限対策

```rust
// 1. キャッシュ活用（24時間有効）
// 同じCVE IDの再検索は自動的にキャッシュから返される

// 2. バッチ処理で待機時間を挿入
for chunk in cve_ids.chunks(5) {
    let indicators: Vec<_> = chunk.iter()
        .map(|cve| create_indicator(cve))
        .collect();
    
    let threats = provider.batch_check_indicators(&indicators).await?;
    
    // 次のバッチまで待機
    tokio::time::sleep(Duration::from_secs(30)).await;
}

// 3. レート制限ステータス確認
let status = provider.get_rate_limit_status().await?;
if status.is_limited {
    println!("Rate limit reached. Wait until: {}", status.reset_at);
}
```

## キャッシュ戦略

### 自動キャッシング

- **TTL**: 24時間
- **キー**: CVE ID
- **値**: 脅威情報 + キャッシュ日時
- **恩恵**: API呼び出し削減、高速レスポンス

### キャッシュヒット率向上

```rust
// よく検索されるCVEを事前にキャッシュ
let critical_cves = vec![
    "CVE-2021-44228", // Log4Shell
    "CVE-2021-45046", // Log4Shell variant
    "CVE-2014-0160",  // Heartbleed
];

for cve in critical_cves {
    let indicator = create_indicator(cve);
    let _ = provider.check_indicator(&indicator).await;
}

println!("Pre-cached {} CVEs", provider.cache_size().await);
```

## エラーハンドリング

```rust
use mcp_rs::threat_intelligence::types::ThreatError;

match provider.check_indicator(&indicator).await {
    Ok(threats) => {
        // 成功処理
    }
    Err(ThreatError::RateLimitExceeded(provider)) => {
        eprintln!("Rate limit exceeded for {}", provider);
        // 30秒待機してリトライ
        tokio::time::sleep(Duration::from_secs(30)).await;
    }
    Err(ThreatError::NetworkError(msg)) => {
        eprintln!("Network error: {}", msg);
        // ネットワーク問題の処理
    }
    Err(ThreatError::ConfigurationError(msg)) => {
        eprintln!("Invalid CVE ID format: {}", msg);
        // 入力検証エラー
    }
    Err(ThreatError::TimeoutError(msg)) => {
        eprintln!("Request timeout: {}", msg);
        // タイムアウト延長を検討
    }
    Err(e) => {
        eprintln!("Other error: {}", e);
    }
}
```

## デモプログラム

完全なデモプログラムを実行:

```powershell
cargo run --example cve_demo
```

デモには以下が含まれます：

1. ヘルスチェック
2. Log4Shell CVE検索
3. Heartbleed CVE検索
4. キーワード検索
5. バッチCVEチェック
6. キャッシュ統計
7. 無効CVE ID処理
8. レート制限ステータス

## テスト

### 単体テスト実行

```powershell
cargo test --test test_cve_provider
```

### 統合テスト実行（実際のAPI使用）

```powershell
# 統合テスト実行（ignoreフラグ付きテスト含む）
cargo test --test test_cve_provider -- --ignored
```

**注意**: 統合テストは実際のNVD APIを呼び出すため、レート制限に注意してください。

## ベストプラクティス

### 1. CVE ID検証

```rust
// 有効なCVE ID形式: CVE-YYYY-NNNNN
// YYYY: 4桁の年
// NNNNN: 4桁以上の数字

let valid_cve = "CVE-2021-44228"; // ✅ OK
let invalid_cve = "CVE-99-1";     // ❌ NG
```

### 2. タイムアウト設定

```rust
// NVDは応答が遅い場合があるため、長めのタイムアウトを推奨
let mut config = create_config();
config.timeout_seconds = 30; // 最低30秒推奨
```

### 3. エラーリトライ

```rust
async fn check_cve_with_retry(
    provider: &CVEProvider,
    cve_id: &str,
    max_retries: u32,
) -> Result<Vec<ThreatIntelligence>, ThreatError> {
    let mut retries = 0;
    
    loop {
        let indicator = create_indicator(cve_id);
        match provider.check_indicator(&indicator).await {
            Ok(threats) => return Ok(threats),
            Err(ThreatError::RateLimitExceeded(_)) if retries < max_retries => {
                retries += 1;
                tokio::time::sleep(Duration::from_secs(30)).await;
            }
            Err(e) => return Err(e),
        }
    }
}
```

### 4. バッチ処理の最適化

```rust
// 大量のCVEを効率的に処理
async fn process_large_cve_list(
    provider: &CVEProvider,
    cve_list: Vec<String>,
) -> Result<Vec<ThreatIntelligence>, ThreatError> {
    let batch_size = 5; // 5リクエスト/30秒制限に合わせる
    let mut all_threats = Vec::new();
    
    for chunk in cve_list.chunks(batch_size) {
        let indicators: Vec<_> = chunk.iter()
            .map(|cve| create_indicator(cve))
            .collect();
        
        let threats = provider.batch_check_indicators(&indicators).await?;
        all_threats.extend(threats);
        
        // レート制限回避のため待機
        tokio::time::sleep(Duration::from_secs(30)).await;
    }
    
    Ok(all_threats)
}
```

## トラブルシューティング

### よくある問題

#### 1. レート制限超過

```
Error: RateLimitExceeded("CVE")
```

**解決策**:
- 30秒待機してリトライ
- バッチサイズを小さくする
- キャッシュを活用する
- APIキーを取得する

#### 2. タイムアウト

```
Error: TimeoutError("request timeout after 30s")
```

**解決策**:
- `timeout_seconds`を60秒以上に延長
- ネットワーク接続を確認
- NVDのステータスページを確認

#### 3. CVE が見つからない

```
Ok(vec![]) // 空の結果
```

**解決策**:
- CVE ID形式を確認（CVE-YYYY-NNNNN）
- CVEが実際に存在するか確認
- 最近公開されたCVEは遅延がある場合がある

#### 4. パースエラー

```
Error: ParsingError("Missing vulnerabilities field")
```

**解決策**:
- NVD APIのレスポンス形式変更の可能性
- プロバイダーのバージョンアップを確認

## パフォーマンス考慮事項

### レスポンス時間

- **キャッシュヒット**: <1ms
- **キャッシュミス**: 500ms-3秒（ネットワーク依存）
- **キーワード検索**: 1-5秒（結果数による）

### 最適化テクニック

1. **キャッシュ活用**: 同じCVEの再検索を避ける
2. **バッチ処理**: 複数CVEをまとめて処理
3. **並列処理**: レート制限内で並列化
4. **非同期処理**: tokioの非同期機能を活用

## 関連リソース

- [NVD API Documentation](https://nvd.nist.gov/developers/vulnerabilities)
- [CVE Numbering Authority](https://www.cve.org/)
- [CVSS Specification](https://www.first.org/cvss/)
- [Issue #77: 脅威インテリジェンス統合](https://github.com/n-takatsu/mcp-rs/issues/77)

## ライセンス

MIT OR Apache-2.0
