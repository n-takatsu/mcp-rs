apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: securitypolicies.mcp.n-takatsu.dev
  annotations:
    controller-gen.kubebuilder.io/version: v0.13.0
spec:
  group: mcp.n-takatsu.dev
  names:
    kind: SecurityPolicy
    listKind: SecurityPolicyList
    plural: securitypolicies
    singular: securitypolicy
    shortNames:
      - secpol
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          description: SecurityPolicy is the Schema for the securitypolicies API
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              type: object
              description: SecurityPolicySpec defines the desired state of SecurityPolicy
              required:
                - enabled
              properties:
                enabled:
                  type: boolean
                  default: true
                  description: Enable security policy enforcement
                authentication:
                  type: object
                  description: Authentication settings
                  properties:
                    required:
                      type: boolean
                      default: true
                    methods:
                      type: array
                      items:
                        type: string
                        enum:
                          - jwt
                          - oauth2
                          - apikey
                          - mtls
                    jwtSecret:
                      type: string
                      description: JWT secret (use Kubernetes Secret)
                authorization:
                  type: object
                  description: Authorization settings
                  properties:
                    mode:
                      type: string
                      enum:
                        - rbac
                        - abac
                        - opa
                      default: rbac
                    allowedRoles:
                      type: array
                      items:
                        type: string
                rateLimiting:
                  type: object
                  description: Rate limiting configuration
                  properties:
                    enabled:
                      type: boolean
                      default: true
                    requestsPerMinute:
                      type: integer
                      minimum: 1
                      default: 100
                    burstSize:
                      type: integer
                      minimum: 1
                      default: 200
                networkPolicy:
                  type: object
                  description: Network security policy
                  properties:
                    allowedPorts:
                      type: array
                      items:
                        type: integer
                    blockedIPs:
                      type: array
                      items:
                        type: string
                    allowedCIDRs:
                      type: array
                      items:
                        type: string
                encryption:
                  type: object
                  description: Encryption settings
                  properties:
                    tlsEnabled:
                      type: boolean
                      default: true
                    tlsVersion:
                      type: string
                      enum:
                        - "1.2"
                        - "1.3"
                      default: "1.3"
                    certSecretName:
                      type: string
                      description: Kubernetes Secret containing TLS cert
                audit:
                  type: object
                  description: Audit logging settings
                  properties:
                    enabled:
                      type: boolean
                      default: true
                    logLevel:
                      type: string
                      enum:
                        - info
                        - warn
                        - error
                      default: info
                    retentionDays:
                      type: integer
                      minimum: 1
                      default: 30
                threatIntelligence:
                  type: object
                  description: Threat intelligence integration
                  properties:
                    enabled:
                      type: boolean
                      default: false
                    abuseIPDBEnabled:
                      type: boolean
                      default: false
                    abuseIPDBApiKey:
                      type: string
                      description: AbuseIPDB API key (use Kubernetes Secret)
            status:
              type: object
              description: SecurityPolicyStatus defines the observed state of SecurityPolicy
              properties:
                phase:
                  type: string
                  enum:
                    - Active
                    - Inactive
                    - Error
                appliedAt:
                  type: string
                  format: date-time
                  description: Last time policy was applied
                violations:
                  type: integer
                  description: Number of policy violations detected
                conditions:
                  type: array
                  items:
                    type: object
                    required:
                      - type
                      - status
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                      lastTransitionTime:
                        type: string
                        format: date-time
                      reason:
                        type: string
                      message:
                        type: string
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Enabled
          type: boolean
          jsonPath: .spec.enabled
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: Violations
          type: integer
          jsonPath: .status.violations
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
