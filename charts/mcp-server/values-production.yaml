# Production environment values
# This overrides the default values.yaml for production deployments

global:
  environment: production

# Full HA configuration
replicaCount: 5

resources:
  limits:
    cpu: 2000m
    memory: 4Gi
  requests:
    cpu: 500m
    memory: 1Gi

# Aggressive autoscaling for production
autoscaling:
  enabled: true
  minReplicas: 5
  maxReplicas: 20
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 15
      - type: Pods
        value: 3
        periodSeconds: 15
      selectPolicy: Max

# Strict PDB for production
podDisruptionBudget:
  enabled: true
  minAvailable: 3

# Production configuration
config:
  logLevel: warn
  logFormat: json
  
  securityPolicy:
    enabled: true
    policyFile: /etc/mcp/security-policy-production.toml
  
  plugins:
    enabled: true
    isolationLevel: container
  
  rateLimit:
    enabled: true
    requestsPerSecond: 2000
    burstSize: 4000
  
  database:
    enabled: true
    type: postgresql
    host: postgresql-ha.database.svc.cluster.local
    port: 5432
    name: mcpdb_prod
  
  redis:
    enabled: true
    host: redis-ha.cache.svc.cluster.local
    port: 6379

# Production persistence with high performance storage
persistence:
  enabled: true
  size: 50Gi
  storageClass: "fast-ssd"
  annotations:
    volume.beta.kubernetes.io/storage-class: "fast-ssd"

# Full monitoring stack
monitoring:
  enabled: true
  serviceMonitor:
    enabled: true
    interval: 15s
    scrapeTimeout: 5s
  prometheusRules:
    enabled: true
    rules:
      - alert: MCPServerHighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate detected"
          description: "Error rate is above 5% for 5 minutes"
      - alert: MCPServerHighLatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High latency detected"
          description: "95th percentile latency is above 1s"

# Production ingress with strict TLS
ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
    nginx.ingress.kubernetes.io/rate-limit: "1000"
    nginx.ingress.kubernetes.io/limit-rps: "100"
  hosts:
    - host: mcp-server.production.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: mcp-server-production-tls
      hosts:
        - mcp-server.production.example.com

# Maximum security
securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000
  seccompProfile:
    type: RuntimeDefault

containerSecurityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 1000
  capabilities:
    drop:
      - ALL

# Production node selection
nodeSelector:
  kubernetes.io/os: linux
  workload: production
  instance-type: compute-optimized

# Strict pod anti-affinity
affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
            - key: app
              operator: In
              values:
                - mcp-server
        topologyKey: kubernetes.io/hostname
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - mcp-server
          topologyKey: topology.kubernetes.io/zone

# Production tolerations
tolerations:
  - key: "dedicated"
    operator: "Equal"
    value: "production"
    effect: "NoSchedule"

# Production environment variables
env:
  - name: ENVIRONMENT
    value: "production"
  - name: ENABLE_DEBUG_ENDPOINTS
    value: "false"

envFrom:
  - secretRef:
      name: mcp-server-prod-secrets
  - configMapRef:
      name: mcp-server-prod-config

# Strict network policies
networkPolicy:
  enabled: true
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
      - namespaceSelector:
          matchLabels:
            name: ingress-nginx
      ports:
      - protocol: TCP
        port: 3000
  egress:
    - to:
      - namespaceSelector:
          matchLabels:
            name: database
      ports:
      - protocol: TCP
        port: 5432
    - to:
      - namespaceSelector:
          matchLabels:
            name: cache
      ports:
      - protocol: TCP
        port: 6379
    - to:
      - namespaceSelector: {}
      ports:
      - protocol: TCP
        port: 443

# Backup enabled for production
backup:
  enabled: true
  schedule: "0 2 * * *"
  retention: 30
  storageClass: "standard"
  volumeSize: 100Gi

# Canary deployment strategy
strategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 2
    maxUnavailable: 0

# High priority for production pods
priorityClassName: "system-cluster-critical"

# Production termination grace period
terminationGracePeriodSeconds: 60

# External secrets integration
secrets:
  enabled: true
  externalSecrets:
    enabled: true
    backendType: secretsManager
