<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP-RS ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç·¨é›†ãƒ‡ãƒ¢</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .demo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        .panel {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        .editor {
            min-height: 300px;
            background: rgba(0, 0, 0, 0.3);
            border: none;
            border-radius: 8px;
            padding: 15px;
            color: white;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            resize: vertical;
            width: 100%;
        }
        .editor:focus {
            outline: 2px solid #4CAF50;
        }
        button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .status {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
        }
        .connected { background-color: rgba(76, 175, 80, 0.3); }
        .disconnected { background-color: rgba(244, 67, 54, 0.3); }
        .log {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .api-panel {
            grid-column: 1 / -1;
        }
        input[type="text"] {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            padding: 10px;
            color: white;
            width: 200px;
            margin: 5px;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #4CAF50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ MCP-RS ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç·¨é›†ãƒ‡ãƒ¢</h1>
        
        <div class="demo-grid">
            <!-- å·¦å´: ã‚¨ãƒ‡ã‚£ã‚¿1 -->
            <div class="panel">
                <h3>ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼1 ã‚¨ãƒ‡ã‚£ã‚¿</h3>
                <div id="status1" class="status disconnected">
                    çŠ¶æ…‹: æœªæ¥ç¶š
                </div>
                <button onclick="createSession('user1', 1)">ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ</button>
                <button onclick="connectWebSocket(1)" id="connect1" disabled>æ¥ç¶š</button>
                <button onclick="disconnectWebSocket(1)" id="disconnect1" disabled>åˆ‡æ–­</button>
                <textarea id="editor1" class="editor" placeholder="ã“ã“ã«å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
            </div>
            
            <!-- å³å´: ã‚¨ãƒ‡ã‚£ã‚¿2 -->
            <div class="panel">
                <h3>ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼2 ã‚¨ãƒ‡ã‚£ã‚¿</h3>
                <div id="status2" class="status disconnected">
                    çŠ¶æ…‹: æœªæ¥ç¶š
                </div>
                <button onclick="createSession('user2', 2)">ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ</button>
                <button onclick="connectWebSocket(2)" id="connect2" disabled>æ¥ç¶š</button>
                <button onclick="disconnectWebSocket(2)" id="disconnect2" disabled>åˆ‡æ–­</button>
                <textarea id="editor2" class="editor" placeholder="ã“ã“ã«å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
            </div>
        </div>
        
        <!-- APIç®¡ç†ãƒ‘ãƒãƒ« -->
        <div class="panel api-panel">
            <h3>ğŸ”§ APIç®¡ç†</h3>
            <div>
                <input type="text" id="sessionIdInput" placeholder="ã‚»ãƒƒã‚·ãƒ§ãƒ³ID">
                <button onclick="getSessionInfo()">ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±å–å¾—</button>
                <button onclick="activateSession()">ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆ</button>
                <button onclick="healthCheck()">å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯</button>
            </div>
            <div id="apiResponse" class="log"></div>
        </div>
        
        <!-- ãƒ­ã‚°ãƒ‘ãƒãƒ« -->
        <div class="panel">
            <h3>ğŸ“ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ãƒ­ã‚°</h3>
            <div id="log" class="log"></div>
            <button onclick="clearLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹
        let sessions = {1: null, 2: null};
        let websockets = {1: null, 2: null};
        
        // ãƒ­ã‚°å‡ºåŠ›
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        // ãƒ­ã‚°ã‚¯ãƒªã‚¢
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(userId, message, connected = false) {
            const statusElement = document.getElementById(`status${userId}`);
            statusElement.textContent = `çŠ¶æ…‹: ${message}`;
            statusElement.className = `status ${connected ? 'connected' : 'disconnected'}`;
        }
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
        async function createSession(userName, userId) {
            try {
                const response = await fetch('/api/sessions', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: userName, client_info: 'web-demo'})
                });
                
                if (response.ok) {
                    const session = await response.json();
                    sessions[userId] = session;
                    log(`âœ… ${userName} ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ: ${session.session_id}`);
                    updateStatus(userId, `ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæ¸ˆã¿: ${session.session_id.substring(0, 8)}...`);
                    document.getElementById(`connect${userId}`).disabled = false;
                } else {
                    log(`âŒ ${userName} ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆå¤±æ•—: ${response.status}`);
                }
            } catch (error) {
                log(`âŒ ${userName} ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        // WebSocketæ¥ç¶š
        function connectWebSocket(userId) {
            const session = sessions[userId];
            if (!session) {
                log(`âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼${userId}: ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“`);
                return;
            }
            
            const wsUrl = `ws://localhost:3000/ws?session_id=${session.session_id}`;
            const ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                log(`ğŸ”— ãƒ¦ãƒ¼ã‚¶ãƒ¼${userId} WebSocketæ¥ç¶šæˆåŠŸ`);
                updateStatus(userId, 'æ¥ç¶šæ¸ˆã¿', true);
                document.getElementById(`connect${userId}`).disabled = true;
                document.getElementById(`disconnect${userId}`).disabled = false;
                
                // ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆé€ä¿¡
                setInterval(() => {
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            id: crypto.randomUUID(),
                            type: 'heartbeat',
                            payload: {},
                            timestamp: new Date().toISOString()
                        }));
                    }
                }, 30000);
            };
            
            ws.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    log(`ğŸ“¨ ãƒ¦ãƒ¼ã‚¶ãƒ¼${userId} å—ä¿¡: ${message.type}`);
                    
                    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç·¨é›†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‡¦ç†
                    if (message.type === 'realtime_edit' && message.session_info) {
                        const otherUserId = userId === 1 ? 2 : 1;
                        const otherEditor = document.getElementById(`editor${otherUserId}`);
                        if (otherEditor && message.payload.content) {
                            otherEditor.value = message.payload.content;
                            log(`ğŸ”„ ãƒ¦ãƒ¼ã‚¶ãƒ¼${otherUserId} ã‚¨ãƒ‡ã‚£ã‚¿åŒæœŸ`);
                        }
                    }
                } catch (error) {
                    log(`âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼${userId} ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è§£æã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
            };
            
            ws.onclose = function() {
                log(`ğŸ”Œ ãƒ¦ãƒ¼ã‚¶ãƒ¼${userId} WebSocketåˆ‡æ–­`);
                updateStatus(userId, 'åˆ‡æ–­æ¸ˆã¿');
                document.getElementById(`connect${userId}`).disabled = false;
                document.getElementById(`disconnect${userId}`).disabled = true;
            };
            
            ws.onerror = function(error) {
                log(`âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼${userId} WebSocketã‚¨ãƒ©ãƒ¼: ${error}`);
            };
            
            websockets[userId] = ws;
            
            // ã‚¨ãƒ‡ã‚£ã‚¿ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
            const editor = document.getElementById(`editor${userId}`);
            editor.oninput = function() {
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        id: crypto.randomUUID(),
                        type: 'realtime_edit',
                        payload: {
                            content: editor.value,
                            cursor_position: editor.selectionStart,
                            user_id: `user${userId}`
                        },
                        timestamp: new Date().toISOString()
                    }));
                }
            };
        }
        
        // WebSocketåˆ‡æ–­
        function disconnectWebSocket(userId) {
            const ws = websockets[userId];
            if (ws) {
                ws.close();
                websockets[userId] = null;
            }
        }
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±å–å¾—
        async function getSessionInfo() {
            const sessionId = document.getElementById('sessionIdInput').value;
            if (!sessionId) {
                alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            try {
                const response = await fetch(`/api/sessions/${sessionId}`);
                const result = response.ok ? await response.json() : {error: response.status};
                document.getElementById('apiResponse').innerHTML = 
                    '<pre>' + JSON.stringify(result, null, 2) + '</pre>';
                log(`ğŸ“‹ ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±å–å¾—: ${sessionId}`);
            } catch (error) {
                document.getElementById('apiResponse').innerHTML = 
                    '<pre>ã‚¨ãƒ©ãƒ¼: ' + error.message + '</pre>';
            }
        }
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆ
        async function activateSession() {
            const sessionId = document.getElementById('sessionIdInput').value;
            if (!sessionId) {
                alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            try {
                const response = await fetch(`/api/sessions/${sessionId}/activate`, {
                    method: 'POST'
                });
                const result = response.ok ? await response.json() : {error: response.status};
                document.getElementById('apiResponse').innerHTML = 
                    '<pre>' + JSON.stringify(result, null, 2) + '</pre>';
                log(`ğŸ”„ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆ: ${sessionId}`);
            } catch (error) {
                document.getElementById('apiResponse').innerHTML = 
                    '<pre>ã‚¨ãƒ©ãƒ¼: ' + error.message + '</pre>';
            }
        }
        
        // å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯
        async function healthCheck() {
            try {
                const response = await fetch('/health');
                const result = await response.json();
                document.getElementById('apiResponse').innerHTML = 
                    '<pre>' + JSON.stringify(result, null, 2) + '</pre>';
                log('ğŸ’š å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ');
            } catch (error) {
                document.getElementById('apiResponse').innerHTML = 
                    '<pre>ã‚¨ãƒ©ãƒ¼: ' + error.message + '</pre>';
            }
        }
        
        // åˆæœŸåŒ–
        log('ğŸŒŸ MCP-RS ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç·¨é›†ãƒ‡ãƒ¢ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
        log('ğŸ“ ä½¿ç”¨æ–¹æ³•:');
        log('1. å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ');
        log('2. WebSocketã«æ¥ç¶š');
        log('3. ã‚¨ãƒ‡ã‚£ã‚¿ã«å…¥åŠ›ã—ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã‚’ç¢ºèª');
    </script>
</body>
</html>