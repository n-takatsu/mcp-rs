name: ğŸ“Š Weekly ROADMAP Health Check

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ 9:00 JST ã«å®Ÿè¡Œ
    - cron: '0 0 * * 1'  # UTC 00:00 Monday = JST 09:00 Monday
  workflow_dispatch:
    inputs:
      report_type:
        description: 'Select report type'
        type: choice
        options:
          - 'weekly'
          - 'milestone'
          - 'comprehensive'
        default: 'weekly'

jobs:
  roadmap-health-check:
    runs-on: ubuntu-latest
    name: ğŸ” ROADMAP Health Assessment

    permissions:
      issues: write
      discussions: write
      contents: write

    steps:
      - name: ğŸ›’ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“Š Generate Health Metrics
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "# ğŸ¯ mcp-rs ROADMAP Health Check Report" > health_report.md
          echo "**Generated**: $(date '+%Y-%m-%d %H:%M:%S JST')" >> health_report.md
          echo "" >> health_report.md

          # ğŸ“Š Overall Project Health
          echo "## ğŸ“Š Overall Project Health" >> health_report.md
          echo "" >> health_report.md

          total_issues=$(gh issue list --state all --json number | jq length)
          open_issues=$(gh issue list --state open --json number | jq length)
          closed_issues=$((total_issues - open_issues))

          if [[ $total_issues -gt 0 ]]; then
            completion_rate=$((closed_issues * 100 / total_issues))
            echo "- **Total Issues**: $total_issues" >> health_report.md
            echo "- **Completed**: $closed_issues ($completion_rate%)" >> health_report.md
            echo "- **In Progress**: $open_issues" >> health_report.md
          fi

          echo "" >> health_report.md

          # ğŸ¯ Milestone Progress Analysis
          echo "## ğŸ¯ Milestone Progress Analysis" >> health_report.md
          echo "" >> health_report.md

          for milestone in "v0.2.0-beta" "v0.3.0" "v1.0.0"; do
            echo "### ğŸ“¦ $milestone" >> health_report.md
            echo "" >> health_report.md

            # ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³çµ±è¨ˆ
            milestone_total=$(gh issue list --milestone "$milestone" --state all --json number | jq length)
            milestone_open=$(gh issue list --milestone "$milestone" --state open --json number | jq length)
            milestone_closed=$((milestone_total - milestone_open))

            # Epic çµ±è¨ˆ
            epic_total=$(gh issue list --milestone "$milestone" --label "epic" --state all --json number | jq length)
            epic_open=$(gh issue list --milestone "$milestone" --label "epic" --state open --json number | jq length)
            epic_closed=$((epic_total - epic_open))

            # Sub-Issue çµ±è¨ˆ
            sub_total=$(gh issue list --milestone "$milestone" --label "sub-issue" --state all --json number | jq length)
            sub_open=$(gh issue list --milestone "$milestone" --label "sub-issue" --state open --json number | jq length)
            sub_closed=$((sub_total - sub_open))

            if [[ $milestone_total -gt 0 ]]; then
              milestone_progress=$((milestone_closed * 100 / milestone_total))
              echo "**Progress**: ${milestone_progress}% ($milestone_closed/$milestone_total completed)" >> health_report.md
            else
              echo "**Progress**: Not started" >> health_report.md
            fi

            echo "" >> health_report.md
            echo "| Category | Total | Completed | In Progress | Progress |" >> health_report.md
            echo "|----------|-------|-----------|-------------|----------|" >> health_report.md

            if [[ $epic_total -gt 0 ]]; then
              epic_progress=$((epic_closed * 100 / epic_total))
              echo "| Epic Issues | $epic_total | $epic_closed | $epic_open | ${epic_progress}% |" >> health_report.md
            else
              echo "| Epic Issues | 0 | 0 | 0 | N/A |" >> health_report.md
            fi

            if [[ $sub_total -gt 0 ]]; then
              sub_progress=$((sub_closed * 100 / sub_total))
              echo "| Sub-Issues | $sub_total | $sub_closed | $sub_open | ${sub_progress}% |" >> health_report.md
            else
              echo "| Sub-Issues | 0 | 0 | 0 | N/A |" >> health_report.md
            fi

            echo "" >> health_report.md

            # ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³æœŸæ—¥ãƒã‚§ãƒƒã‚¯
            milestone_due=$(gh api repos/${{ github.repository }}/milestones --jq ".[] | select(.title == \"$milestone\") | .due_on")
            if [[ ! -z "$milestone_due" && "$milestone_due" != "null" ]]; then
              due_date=$(date -d "$milestone_due" '+%Y-%m-%d')
              current_date=$(date '+%Y-%m-%d')

              if [[ "$current_date" > "$due_date" ]]; then
                echo "âš ï¸ **Status**: OVERDUE (due: $due_date)" >> health_report.md
              else
                days_remaining=$(( ($(date -d "$due_date" +%s) - $(date -d "$current_date" +%s)) / 86400 ))
                echo "â° **Status**: ${days_remaining} days remaining (due: $due_date)" >> health_report.md
              fi
            fi

            echo "" >> health_report.md
          done

          # ğŸš¨ Health Alerts & Recommendations
          echo "## ğŸš¨ Health Alerts & Recommendations" >> health_report.md
          echo "" >> health_report.md

          # P0 Critical Issues ãƒã‚§ãƒƒã‚¯
          p0_issues=$(gh issue list --label "priority-p0-critical" --state open --json number | jq length)
          if [[ $p0_issues -gt 0 ]]; then
            echo "### ğŸš¨ Critical Priority Issues" >> health_report.md
            echo "- **$p0_issues P0 Critical issues** require immediate attention" >> health_report.md

            gh issue list --label "priority-p0-critical" --state open --json number,title,url \
              --jq '.[] | "- [#" + (.number|tostring) + "](" + .url + "): " + .title' >> health_report.md
            echo "" >> health_report.md
          fi

          # é•·æœŸã‚ªãƒ¼ãƒ—ãƒ³ Issue ãƒã‚§ãƒƒã‚¯
          old_issues=$(gh issue list --state open --json number,createdAt,title,url \
            --jq '[.[] | select((now - (.createdAt | fromdateiso8601)) > (30 * 86400))] | length')
          if [[ $old_issues -gt 0 ]]; then
            echo "### â° Long-running Issues" >> health_report.md
            echo "- **$old_issues issues** have been open for more than 30 days" >> health_report.md
            echo "- Consider priority review or closure" >> health_report.md
            echo "" >> health_report.md
          fi

          # v0.2.0-beta ãƒªãƒªãƒ¼ã‚¹å¥å…¨æ€§
          beta_due="2026-01-31"
          beta_current_progress=$(gh issue list --milestone "v0.2.0-beta" --state all --json number | jq length)
          beta_completed=$(gh issue list --milestone "v0.2.0-beta" --state closed --json number | jq length)

          if [[ $beta_current_progress -gt 0 ]]; then
            beta_completion_rate=$((beta_completed * 100 / beta_current_progress))

            if [[ $beta_completion_rate -lt 50 ]]; then
              echo "### âš ï¸ v0.2.0-beta Release Risk" >> health_report.md
              echo "- **Current Progress**: ${beta_completion_rate}%" >> health_report.md
              echo "- **Risk Level**: HIGH - Consider scope adjustment or timeline extension" >> health_report.md
              echo "- **Recommendation**: Focus on P0/P1 features only" >> health_report.md
              echo "" >> health_report.md
            fi
          fi

          # ğŸ¯ Action Items
          echo "## ğŸ¯ Recommended Action Items" >> health_report.md
          echo "" >> health_report.md

          echo "### This Week Priority" >> health_report.md
          echo "- [ ] Review and address all P0 Critical issues" >> health_report.md
          echo "- [ ] Update Epic Issues with current Sub-Issue progress" >> health_report.md
          echo "- [ ] Validate v0.2.0-beta milestone timeline" >> health_report.md
          echo "- [ ] Close completed Sub-Issues and update Epic status" >> health_report.md
          echo "" >> health_report.md

          echo "### Process Improvements" >> health_report.md
          echo "- [ ] Ensure all new issues are properly labeled and milestoned" >> health_report.md
          echo "- [ ] Update ROADMAP.md if significant scope changes occurred" >> health_report.md
          echo "- [ ] Review and optimize automation workflows if needed" >> health_report.md
          echo "" >> health_report.md

          # ğŸ“ˆ Trends & Insights
          echo "## ğŸ“ˆ Development Trends" >> health_report.md
          echo "" >> health_report.md

          # é€±æ¬¡ Issue ä½œæˆ/å®Œäº†çµ±è¨ˆ
          week_ago=$(date -d "7 days ago" '+%Y-%m-%d')
          created_this_week=$(gh issue list --state all --json createdAt \
            --jq "[.[] | select(.createdAt > \"${week_ago}T00:00:00Z\")] | length")
          closed_this_week=$(gh issue list --state closed --json closedAt \
            --jq "[.[] | select(.closedAt != null and .closedAt > \"${week_ago}T00:00:00Z\")] | length")

          echo "### Weekly Activity" >> health_report.md
          echo "- **Issues Created**: $created_this_week" >> health_report.md
          echo "- **Issues Completed**: $closed_this_week" >> health_report.md

          if [[ $created_this_week -gt 0 && $closed_this_week -gt 0 ]]; then
            velocity_ratio=$((closed_this_week * 100 / created_this_week))
            echo "- **Completion Velocity**: ${velocity_ratio}%" >> health_report.md

            if [[ $velocity_ratio -lt 80 ]]; then
              echo "- âš ï¸ **Trend**: Issue backlog growing - consider capacity planning" >> health_report.md
            elif [[ $velocity_ratio -gt 120 ]]; then
              echo "- âœ… **Trend**: Strong delivery velocity - on track" >> health_report.md
            fi
          fi

          echo "" >> health_report.md

          # ğŸ”— Quick Links
          echo "## ğŸ”— Quick Links" >> health_report.md
          echo "" >> health_report.md
          echo "- ğŸ¯ [Project Board](https://github.com/${{ github.repository }}/projects/1)" >> health_report.md
          echo "- ğŸ“Š [Milestones](https://github.com/${{ github.repository }}/milestones)" >> health_report.md
          echo "- ğŸ—ºï¸ [ROADMAP.md](https://github.com/${{ github.repository }}/blob/develop/ROADMAP.md)" >> health_report.md
          echo "- ğŸ“‹ [Epic Issues](https://github.com/${{ github.repository }}/issues?q=is%3Aopen+label%3Aepic)" >> health_report.md
          echo "- ğŸš¨ [Critical Issues](https://github.com/${{ github.repository }}/issues?q=is%3Aopen+label%3Apriority-p0-critical)" >> health_report.md
          echo "" >> health_report.md

      - name: ğŸ“Š Create Health Check Issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯ Issue ä½œæˆ
          current_date=$(date '+%Y-%m-%d')
          health_content=$(cat health_report.md)

          gh issue create \
            --title "ğŸ“Š Weekly ROADMAP Health Check - $current_date" \
            --body "$health_content

          ---

          **Auto-generated by**: [ROADMAP Health Check Workflow](.github/workflows/roadmap-health.yml)
          **Report Type**: Weekly Automated Health Assessment
          **Next Check**: $(date -d "+7 days" '+%Y-%m-%d')

          This issue will be automatically closed after 7 days. For persistent tracking, use the Project Board." \
            --label "roadmap-health,automated,weekly-report" \
            --assignee "n-takatsu"

          # å‰é€±ã® Health Check Issue ã‚’è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º
          week_ago_date=$(date -d "7 days ago" '+%Y-%m-%d')
          previous_issues=$(gh issue list --label "roadmap-health,weekly-report" --state open --json number,title \
            --jq ".[] | select(.title | contains(\"$week_ago_date\")) | .number")

          for issue_num in $previous_issues; do
            if [[ ! -z "$issue_num" ]]; then
              gh issue close $issue_num --comment "ğŸ¤– **Auto-closed**: Replaced by newer weekly health check report.

              Archive: This weekly health check has been completed and archived."
            fi
          done

      - name: ğŸ”„ Update ROADMAP Progress Indicators
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # ROADMAP.md ã®é€²æ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼æ›´æ–°

          # å„ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã®é€²æ—è¨ˆç®—
          beta_total=$(gh issue list --milestone "v0.2.0-beta" --state all --json number | jq length)
          beta_closed=$(gh issue list --milestone "v0.2.0-beta" --state closed --json number | jq length)

          v3_total=$(gh issue list --milestone "v0.3.0" --state all --json number | jq length)
          v3_closed=$(gh issue list --milestone "v0.3.0" --state closed --json number | jq length)

          v1_total=$(gh issue list --milestone "v1.0.0" --state all --json number | jq length)
          v1_closed=$(gh issue list --milestone "v1.0.0" --state closed --json number | jq length)

          # é€²æ—ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸è¨ˆç®—
          if [[ $beta_total -gt 0 ]]; then
            beta_progress=$((beta_closed * 100 / beta_total))
          else
            beta_progress=0
          fi

          if [[ $v3_total -gt 0 ]]; then
            v3_progress=$((v3_closed * 100 / v3_total))
          else
            v3_progress=0
          fi

          if [[ $v1_total -gt 0 ]]; then
            v1_progress=$((v1_closed * 100 / v1_total))
          else
            v1_progress=0
          fi

          echo "Calculated Progress:"
          echo "- v0.2.0-beta: ${beta_progress}% ($beta_closed/$beta_total)"
          echo "- v0.3.0: ${v3_progress}% ($v3_closed/$v3_total)"
          echo "- v1.0.0: ${v1_progress}% ($v1_closed/$v1_total)"

          # é€²æ—ãƒãƒƒã‚¸ã®æ›´æ–°ï¼ˆGitHub Issues ãƒªãƒ³ã‚¯ã‚‚æ›´æ–°ï¼‰
          current_date=$(date '+%Yå¹´%mæœˆ%dæ—¥')

          # ãƒ—ãƒ©ã‚°ã‚¤ãƒ³éš”é›¢ã‚·ã‚¹ãƒ†ãƒ ã®é€²æ—æ›´æ–°
          if [[ $beta_progress -gt 75 ]]; then
            plugin_isolation_progress="85%"  # å®Ÿéš›ã®é€²æ—ã«åŸºã¥ãèª¿æ•´
          else
            plugin_isolation_progress="75%"
          fi

          # Dockerçµ±åˆã®é€²æ—æ›´æ–°
          if [[ $beta_progress -gt 30 ]]; then
            docker_progress="60%"  # å®Ÿéš›ã®é€²æ—ã«åŸºã¥ãèª¿æ•´
          else
            docker_progress="50%"
          fi

          # æœ€çµ‚æ›´æ–°æ—¥ã®æ›´æ–°
          sed -i "s|> \*\*æœ€çµ‚æ›´æ–°\*\*:.*|> **æœ€çµ‚æ›´æ–°**: $current_date|g" ROADMAP.md

          # GitHub Issues ãƒªãƒ³ã‚¯ã‚’å®Ÿéš›ã®Issueç•ªå·ã«æ›´æ–°
          sed -i 's|https://github.com/n-takatsu/mcp-rs/issues/NEW|https://github.com/n-takatsu/mcp-rs/issues/17|g' ROADMAP.md

          # ãƒ—ãƒ©ã‚°ã‚¤ãƒ³éš”é›¢ã‚·ã‚¹ãƒ†ãƒ ã®é€²æ—æ›´æ–°
          sed -i "s/ãƒ—ãƒ©ã‚°ã‚¤ãƒ³éš”é›¢ã‚·ã‚¹ãƒ†ãƒ \*\* | 75%/ãƒ—ãƒ©ã‚°ã‚¤ãƒ³éš”é›¢ã‚·ã‚¹ãƒ†ãƒ ** | ${plugin_isolation_progress}/g" ROADMAP.md

          # Dockerçµ±åˆã®é€²æ—æ›´æ–°
          sed -i "s/Dockerçµ±åˆ\*\* | 50%/Dockerçµ±åˆ** | ${docker_progress}/g" ROADMAP.md

          # å¤‰æ›´ãŒã‚ã‚Œã°è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆ
          if [[ -n "$(git status --porcelain ROADMAP.md)" ]]; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action - Health Check"
            git add ROADMAP.md
            git commit -m "ğŸ“Š Weekly ROADMAP progress update - $current_date

            Auto-updated progress indicators:
            - v0.2.0-beta: ${beta_progress}%
            - v0.3.0: ${v3_progress}%
            - v1.0.0: ${v1_progress}%
            - Plugin isolation: ${plugin_isolation_progress}
            - Docker integration: ${docker_progress}

            Generated by: roadmap-health.yml"

            git push
          fi
