name: ğŸ“‹ Issue Management Automation

on:
  issues:
    types: [opened, edited, labeled, unlabeled]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, closed, merged]

jobs:
  issue-automation:
    runs-on: ubuntu-latest
    name: ğŸ¤– Smart Issue Management
    
    permissions:
      issues: write
      contents: read
      pull-requests: write
      
    steps:
      - name: ğŸ›’ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ·ï¸ Auto-label by Title Pattern
        if: github.event_name == 'issues' && github.event.action == 'opened'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          title="${{ github.event.issue.title }}"
          number="${{ github.event.issue.number }}"
          
          # Epic Issues ã®è‡ªå‹•ãƒ©ãƒ™ãƒ«
          if [[ "$title" == *"[EPIC]"* ]]; then
            gh issue edit $number --add-label "epic,priority-high,roadmap-tracked"
            echo "âœ… Added Epic labels to #$number"
          fi
          
          # Sub-Issues ã®è‡ªå‹•ãƒ©ãƒ™ãƒ«  
          if [[ "$title" == *"[SUB]"* ]]; then
            gh issue edit $number --add-label "sub-issue,enhancement,roadmap-tracked"
            echo "âœ… Added Sub-Issue labels to #$number"
          fi
          
          # Bug Issues ã®è‡ªå‹•ãƒ©ãƒ™ãƒ«
          if [[ "$title" == *"[BUG]"* ]] || [[ "$title" == *"bug"* ]] || [[ "$title" == *"Bug"* ]]; then
            gh issue edit $number --add-label "bug,priority-high"
            echo "âœ… Added Bug labels to #$number"
          fi
          
          # Security Issues ã®è‡ªå‹•ãƒ©ãƒ™ãƒ«
          if [[ "$title" == *"security"* ]] || [[ "$title" == *"Security"* ]] || [[ "$title" == *"ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£"* ]]; then
            gh issue edit $number --add-label "security,priority-critical"
            echo "âœ… Added Security labels to #$number"
          fi
          
      - name: ğŸ¯ Auto-assign Milestone by Labels
        if: github.event_name == 'issues' && (github.event.action == 'opened' || github.event.action == 'labeled')
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          number="${{ github.event.issue.number }}"
          title="${{ github.event.issue.title }}"
          
          # v0.2.0-beta ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è‡ªå‹•å‰²ã‚Šå½“ã¦
          if [[ "$title" == *"ãƒ—ãƒ©ã‚°ã‚¤ãƒ³éš”é›¢"* ]] || [[ "$title" == *"å‹•çš„ãƒãƒªã‚·ãƒ¼"* ]] || [[ "$title" == *"Docker"* ]] || [[ "$title" == *"Kubernetes"* ]]; then
            gh issue edit $number --milestone "v0.2.0-beta"
            echo "âœ… Assigned #$number to v0.2.0-beta milestone"
          fi
          
          # v0.3.0 ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è‡ªå‹•å‰²ã‚Šå½“ã¦  
          if [[ "$title" == *"WebSocket"* ]] || [[ "$title" == *"AI"* ]] || [[ "$title" == *"LLM"* ]] || [[ "$title" == *"ç›£è¦–"* ]]; then
            gh issue edit $number --milestone "v0.3.0"
            echo "âœ… Assigned #$number to v0.3.0 milestone"
          fi
          
          # v1.0.0 ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è‡ªå‹•å‰²ã‚Šå½“ã¦
          if [[ "$title" == *"ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚º"* ]] || [[ "$title" == *"SAML"* ]] || [[ "$title" == *"OAuth"* ]] || [[ "$title" == *"ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆ"* ]]; then
            gh issue edit $number --milestone "v1.0.0"  
            echo "âœ… Assigned #$number to v1.0.0 milestone"
          fi
          
      - name: ğŸ”— Auto-link Sub-Issues to Epic
        if: github.event_name == 'issues' && github.event.action == 'opened' && contains(github.event.issue.title, '[SUB]')
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          number="${{ github.event.issue.number }}"
          title="${{ github.event.issue.title }}"
          body="${{ github.event.issue.body }}"
          
          # Epic Issue ç•ªå·ã‚’æœ¬æ–‡ã‹ã‚‰æŠ½å‡º
          epic_number=$(echo "$body" | grep -o "Parent Epic: #[0-9]\+" | head -1 | grep -o "[0-9]\+")
          
          if [[ ! -z "$epic_number" ]]; then
            echo "ğŸ”— Linking Sub-Issue #$number to Epic #$epic_number"
            
            # Epic Issue ã«ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
            gh issue comment $epic_number --body "## ğŸ”— **Sub-Issue Created**

            **#$number**: $title
            
            ğŸ“‹ **Progress Update**:
            - New Sub-Issue automatically linked to this Epic
            - Milestone inheritance applied
            - Project board integration activated
            
            â¡ï¸ [View Sub-Issue #$number](https://github.com/${{ github.repository }}/issues/$number)"
            
            # Epic ã® Milestone ã‚’ Sub-Issue ã«ç¶™æ‰¿
            epic_milestone=$(gh issue view $epic_number --json milestone --jq '.milestone.title // empty')
            if [[ ! -z "$epic_milestone" ]]; then
              gh issue edit $number --milestone "$epic_milestone"
              echo "âœ… Inherited milestone '$epic_milestone' from Epic #$epic_number"
            fi
            
            # Epic ã® Assignees ã‚’ Sub-Issue ã«ç¶™æ‰¿ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            epic_assignees=$(gh issue view $epic_number --json assignees --jq '.assignees[].login // empty' | tr '\n' ' ')
            if [[ ! -z "$epic_assignees" ]]; then
              for assignee in $epic_assignees; do
                gh issue edit $number --add-assignee "$assignee"
              done
              echo "âœ… Inherited assignees from Epic #$epic_number: $epic_assignees"
            fi
          fi
          
      - name: ğŸ“Š Update Epic Progress
        if: github.event_name == 'issues' && github.event.action == 'closed' && contains(github.event.issue.title, '[SUB]')
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          closed_issue="${{ github.event.issue.number }}"
          body="${{ github.event.issue.body }}"
          
          # Epic Issue ç•ªå·ã‚’æŠ½å‡º
          epic_number=$(echo "$body" | grep -o "Parent Epic: #[0-9]\+" | head -1 | grep -o "[0-9]\+")
          
          if [[ ! -z "$epic_number" ]]; then
            echo "ğŸ“Š Updating progress for Epic #$epic_number"
            
            # Epic ã® Milestone ã‹ã‚‰ Sub-Issues ã‚’å–å¾—
            epic_milestone=$(gh issue view $epic_number --json milestone --jq '.milestone.title // empty')
            
            if [[ ! -z "$epic_milestone" ]]; then
              # Sub-Issues ã®é€²æ—çµ±è¨ˆ
              total_subs=$(gh issue list --milestone "$epic_milestone" --label "sub-issue" --state all --json number | jq length)
              closed_subs=$(gh issue list --milestone "$epic_milestone" --label "sub-issue" --state closed --json number | jq length)
              
              if [[ $total_subs -gt 0 ]]; then
                progress=$((closed_subs * 100 / total_subs))
                
                # Epic Issue ã«é€²æ—æ›´æ–°ã‚³ãƒ¡ãƒ³ãƒˆ  
                gh issue comment $epic_number --body "## ğŸ“Š **Epic Progress Update**
                
                ğŸ‰ **Sub-Issue Completed**: #$closed_issue
                
                ### ğŸ“ˆ **Current Progress**:
                - **Completed Sub-Issues**: $closed_subs/$total_subs  
                - **Progress**: ${progress}%
                - **Milestone**: $epic_milestone
                
                $(if [[ $progress -eq 100 ]]; then echo "ğŸ¯ **Epic Ready for Completion!** All Sub-Issues completed."; fi)
                
                â¡ï¸ [View Project Board](https://github.com/${{ github.repository }}/projects/1)"
                
                # Epic ãŒ 100% å®Œäº†æ™‚ã®è‡ªå‹•ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
                if [[ $progress -eq 100 ]]; then
                  gh issue comment $epic_number --body "## ğŸ‰ **Epic Completion Detected!**
                  
                  All Sub-Issues for this Epic have been completed. Consider:
                  
                  - [ ] Final integration testing
                  - [ ] Documentation updates  
                  - [ ] Epic closure and milestone review
                  - [ ] Preparation for next milestone
                  
                  cc: @n-takatsu"
                fi
              fi
            fi
          fi
          
      - name: ğŸš¨ Auto-triage Critical Issues
        if: github.event_name == 'issues' && github.event.action == 'labeled'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          number="${{ github.event.issue.number }}"
          label="${{ github.event.label.name }}"
          
          # Critical ãƒ©ãƒ™ãƒ«ãŒä»˜ã„ãŸå ´åˆã®ç·Šæ€¥å¯¾å¿œ
          if [[ "$label" == "priority-critical" ]] || [[ "$label" == "security" ]] || [[ "$label" == "bug" ]]; then
            echo "ğŸš¨ Critical issue detected: #$number"
            
            # Critical Issue ã®è‡ªå‹•ã‚³ãƒ¡ãƒ³ãƒˆ
            gh issue comment $number --body "## ğŸš¨ **Critical Issue Detected**
            
            This issue has been automatically flagged as **critical priority**.
            
            ### âš¡ **Immediate Actions Required**:
            - [ ] Assign to team lead (@n-takatsu)
            - [ ] Assess impact and severity  
            - [ ] Create hotfix branch if needed
            - [ ] Update stakeholders
            
            ### ğŸ“‹ **Escalation Process**:
            1. **Initial Response**: Within 2 hours
            2. **Impact Assessment**: Within 4 hours  
            3. **Resolution Plan**: Within 8 hours
            4. **Implementation**: As per severity
            
            **Auto-escalated by**: Issue Management Automation"
            
            # Critical Issue ã‚’å¿…ãš Assignee è¨­å®š
            gh issue edit $number --add-assignee "n-takatsu"
            
            # v0.2.0-beta ã® Critical Issue ã¯æœ€å„ªå…ˆ
            current_milestone=$(gh issue view $number --json milestone --jq '.milestone.title // empty')
            if [[ "$current_milestone" == "v0.2.0-beta" ]]; then
              gh issue edit $number --add-label "priority-p0-critical"
            fi
          fi
          
      - name: ğŸ”„ PR Integration with Issues
        if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'closed')
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          pr_number="${{ github.event.pull_request.number }}"
          pr_title="${{ github.event.pull_request.title }}"
          pr_body="${{ github.event.pull_request.body }}"
          pr_state="${{ github.event.pull_request.state }}"
          
          # PR ã‹ã‚‰é–¢é€£ Issue ã‚’æŠ½å‡º
          related_issues=$(echo "$pr_body" | grep -o "#[0-9]\+" | tr -d '#' | head -5)
          
          for issue_num in $related_issues; do
            if [[ ! -z "$issue_num" ]]; then
              echo "ğŸ”— Found related issue: #$issue_num"
              
              if [[ "${{ github.event.action }}" == "opened" ]]; then
                # PR é–‹å§‹æ™‚ã®ã‚³ãƒ¡ãƒ³ãƒˆ
                gh issue comment $issue_num --body "## ğŸ”§ **Development Started**
                
                **Pull Request**: #$pr_number - $pr_title
                
                ğŸ“ **Status**: Development in progress
                ğŸ”— **PR Link**: [$pr_title](https://github.com/${{ github.repository }}/pull/$pr_number)
                
                â¡ï¸ Ready for review and testing once PR is completed."
                
              elif [[ "${{ github.event.action }}" == "closed" && "${{ github.event.pull_request.merged }}" == "true" ]]; then
                # PR ãƒãƒ¼ã‚¸æ™‚ã®ã‚³ãƒ¡ãƒ³ãƒˆ
                gh issue comment $issue_num --body "## âœ… **Implementation Completed**
                
                **Merged PR**: #$pr_number - $pr_title
                
                ğŸ‰ **Status**: Implementation completed and merged
                ğŸ“¦ **Branch**: ${{ github.event.pull_request.head.ref }}
                ğŸ”— **Commit**: ${{ github.event.pull_request.merge_commit_sha }}
                
                This issue is now ready for final validation and closure."
                
                # Sub-Issue ã®å ´åˆã¯è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                issue_title=$(gh issue view $issue_num --json title --jq '.title')
                if [[ "$issue_title" == *"[SUB]"* ]]; then
                  echo "ğŸ¤– Auto-closing Sub-Issue #$issue_num after successful PR merge"
                  gh issue close $issue_num --comment "ğŸ¤– **Auto-closed**: Implementation completed via PR #$pr_number

                  Sub-Issue automatically closed after successful merge. Epic progress updated."
                fi
              fi
            fi
          done