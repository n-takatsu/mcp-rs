name: ğŸ¯ ROADMAP-Project Synchronization

on:
  issues:
    types: [opened, edited, closed, reopened, labeled, unlabeled]
  milestones:
    types: [created, edited, deleted]
  schedule:
    # æ¯æ—¥ 9:00 JST ã« ROADMAP åŒæœŸãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
    - cron: '0 0 * * *'  # UTC 00:00 = JST 09:00
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force complete ROADMAP synchronization'
        type: boolean
        default: false

env:
  PROJECT_NUMBER: 2
  
jobs:
  sync-roadmap-project:
    runs-on: ubuntu-latest
    name: ğŸ”„ ROADMAP-Project Integration
    
    permissions:
      issues: write
      contents: write
      
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: ğŸ“Š Auto-add Issues to Project
        if: github.event_name == 'issues' && github.event.action == 'opened'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # æ–°è¦ Issue ã‚’è‡ªå‹•çš„ã« Project ã«è¿½åŠ 
          gh project item-add ${{ env.PROJECT_NUMBER }} --owner ${{ github.repository_owner }} --url "${{ github.event.issue.html_url }}"
          
      - name: ğŸ·ï¸ Auto-label Epic Issues
        if: github.event_name == 'issues' && contains(github.event.issue.title, '[EPIC]')
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Epic Issue ã«è‡ªå‹•ãƒ©ãƒ™ãƒ«ä»˜ã‘
          gh issue edit ${{ github.event.issue.number }} --add-label "epic,roadmap-tracked"
          
      - name: ğŸ·ï¸ Auto-label Sub-Issues  
        if: github.event_name == 'issues' && contains(github.event.issue.title, '[SUB]')
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Sub-Issue ã«è‡ªå‹•ãƒ©ãƒ™ãƒ«ä»˜ã‘
          gh issue edit ${{ github.event.issue.number }} --add-label "sub-issue,roadmap-tracked"
          
      - name: ğŸ“‹ Set Project Fields for Epic Issues
        if: github.event_name == 'issues' && contains(github.event.issue.title, '[EPIC]')
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Epic Issue ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¨­å®š
          echo "Epic Issue detected: ${{ github.event.issue.title }}"
          
          # Epic å›ºæœ‰ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¨­å®šãƒ­ã‚¸ãƒƒã‚¯
          if [[ "${{ github.event.issue.title }}" == *"Advanced Security"* ]]; then
            echo "Setting fields for Advanced Security Epic"
            # Priority: P1, Release: v0.2.0-beta, Type: Epic
          elif [[ "${{ github.event.issue.title }}" == *"Docker/Kubernetes"* ]]; then
            echo "Setting fields for Docker/K8s Epic"  
            # Priority: P0, Release: v0.2.0-beta, Type: Epic
          elif [[ "${{ github.event.issue.title }}" == *"WebSocket"* ]]; then
            echo "Setting fields for WebSocket Epic"
            # Priority: P1, Release: v0.3.0, Type: Epic
          elif [[ "${{ github.event.issue.title }}" == *"ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚º"* ]]; then
            echo "Setting fields for Enterprise Epic"
            # Priority: P3, Release: v1.0.0, Type: Epic
          fi
          
      - name: ğŸ”— Link Sub-Issues to Epic Parent
        if: github.event_name == 'issues' && contains(github.event.issue.title, '[SUB]')
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Sub-Issue ã® Epic Parent é–¢é€£ä»˜ã‘
          issue_body="${{ github.event.issue.body }}"
          
          # Epic Issue ç•ªå·ã‚’ Issue Body ã‹ã‚‰æŠ½å‡º
          epic_number=$(echo "$issue_body" | grep -o "Parent Epic: #[0-9]\+" | head -1 | grep -o "[0-9]\+")
          
          if [[ ! -z "$epic_number" ]]; then
            echo "Linking Sub-Issue #${{ github.event.issue.number }} to Epic #$epic_number"
            
            # Epic Issue ã«ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
            gh issue comment $epic_number --body "ğŸ”— **Sub-Issue Created**: #${{ github.event.issue.number }} - ${{ github.event.issue.title }}"
            
            # Sub-Issue ã‚’ Epic ã® Milestone ã«è¨­å®š
            epic_milestone=$(gh issue view $epic_number --json milestone --jq '.milestone.title')
            if [[ ! -z "$epic_milestone" && "$epic_milestone" != "null" ]]; then
              gh issue edit ${{ github.event.issue.number }} --milestone "$epic_milestone"
            fi
          fi
          
      - name: ğŸ“Š Generate ROADMAP Progress Report  
        if: github.event_name == 'schedule' || github.event.inputs.force_sync == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # ROADMAP é€²æ—ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          echo "# ğŸ¯ ROADMAP Progress Report - $(date '+%Y-%m-%d')" > roadmap_progress.md
          echo "" >> roadmap_progress.md
          
          # Epic Issues ã®é€²æ—çµ±è¨ˆ
          echo "## ğŸ“Š Epic Issues Status" >> roadmap_progress.md
          echo "" >> roadmap_progress.md
          
          for milestone in "v0.2.0-beta" "v0.3.0" "v1.0.0"; do
            echo "### ğŸ“¦ $milestone" >> roadmap_progress.md
            echo "" >> roadmap_progress.md
            
            # Epic Issues ã‚«ã‚¦ãƒ³ãƒˆ
            epic_count=$(gh issue list --milestone "$milestone" --label "epic" --state all --json number | jq length)
            epic_open=$(gh issue list --milestone "$milestone" --label "epic" --state open --json number | jq length) 
            epic_closed=$(gh issue list --milestone "$milestone" --label "epic" --state closed --json number | jq length)
            
            # Sub-Issues ã‚«ã‚¦ãƒ³ãƒˆ  
            sub_count=$(gh issue list --milestone "$milestone" --label "sub-issue" --state all --json number | jq length)
            sub_open=$(gh issue list --milestone "$milestone" --label "sub-issue" --state open --json number | jq length)
            sub_closed=$(gh issue list --milestone "$milestone" --label "sub-issue" --state closed --json number | jq length)
            
            echo "- **Epic Issues**: $epic_closed/$epic_count completed" >> roadmap_progress.md
            echo "- **Sub-Issues**: $sub_closed/$sub_count completed" >> roadmap_progress.md
            
            if [[ $epic_count -gt 0 ]]; then
              epic_progress=$((epic_closed * 100 / epic_count))
              echo "- **Epic Progress**: ${epic_progress}%" >> roadmap_progress.md
            fi
            
            if [[ $sub_count -gt 0 ]]; then
              sub_progress=$((sub_closed * 100 / sub_count))
              echo "- **Sub-Issue Progress**: ${sub_progress}%" >> roadmap_progress.md
            fi
            
            echo "" >> roadmap_progress.md
          done
          
          # æœ€æ–°ã® Project æƒ…å ±è¿½åŠ 
          echo "## ğŸ¯ Project Board Status" >> roadmap_progress.md  
          echo "" >> roadmap_progress.md
          echo "- **Project**: [mcp-rs ROADMAP Management](https://github.com/${{ github.repository }}/projects/${{ env.PROJECT_NUMBER }})" >> roadmap_progress.md
          echo "- **Last Updated**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> roadmap_progress.md
          echo "- **Total Issues Tracked**: $(gh issue list --label 'roadmap-tracked' --state all --json number | jq length)" >> roadmap_progress.md
          echo "" >> roadmap_progress.md
          
      - name: ğŸ’¬ Create Progress Discussion
        if: github.event_name == 'schedule' || github.event.inputs.force_sync == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # é€±æ¬¡é€²æ— Discussion ä½œæˆï¼ˆæœˆæ›œæ—¥ã®ã¿ï¼‰
          if [[ $(date +%u) == 1 ]]; then
            progress_content=$(cat roadmap_progress.md)
            
            # GitHub Discussions ã«æŠ•ç¨¿
            gh api graphql \
              --field query='
                mutation($repositoryId: ID!, $categoryId: ID!, $title: String!, $body: String!) {
                  createDiscussion(input: {
                    repositoryId: $repositoryId,
                    categoryId: $categoryId,
                    title: $title,
                    body: $body
                  }) {
                    discussion {
                      url
                    }
                  }
                }' \
              --field repositoryId="${{ github.event.repository.node_id }}" \
              --field categoryId="DIC_kwDOQNk6HM4Cjjnj" \
              --field title="ğŸ“Š Weekly ROADMAP Progress - $(date '+%Y-%m-%d')" \
              --field body="$progress_content"
          fi
          
      - name: ğŸ”„ ROADMAP.md Auto-update Check
        if: github.event.inputs.force_sync == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # ROADMAP.md ã®è‡ªå‹•æ›´æ–°ãƒã‚§ãƒƒã‚¯
          echo "Checking ROADMAP.md for required updates..."
          
          # Issue ãƒªãƒ³ã‚¯ã®æ›´æ–°
          current_date=$(date '+%Yå¹´%mæœˆ%dæ—¥')
          
          # GitHub Issues ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ›´æ–°
          sed -i "s|https://github.com/n-takatsu/mcp-rs/issues/NEW|https://github.com/n-takatsu/mcp-rs/issues/17|g" ROADMAP.md
          
          # æœ€çµ‚æ›´æ–°æ—¥ã®æ›´æ–°  
          sed -i "s|> \*\*æœ€çµ‚æ›´æ–°\*\*:.*|> **æœ€çµ‚æ›´æ–°**: $current_date|g" ROADMAP.md
          
          # å¤‰æ›´ãŒã‚ã‚Œã° PR ä½œæˆ
          if [[ -n "$(git status --porcelain ROADMAP.md)" ]]; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action" 
            git add ROADMAP.md
            git commit -m "ğŸ¤– Auto-update ROADMAP.md with current GitHub Issues links

            - Updated GitHub Issues links to actual issue numbers  
            - Updated last modified date: $current_date
            - Automated by roadmap-sync workflow"
            
            # æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã§ PR ä½œæˆ
            branch_name="auto-update/roadmap-$(date '+%Y%m%d')"
            git checkout -b "$branch_name"
            git push origin "$branch_name"
            
            gh pr create \
              --title "ğŸ¤– Auto-update ROADMAP.md - $(date '+%Y-%m-%d')" \
              --body "## ğŸ¯ è‡ªå‹•æ›´æ–°å†…å®¹

            - GitHub Issues ãƒªãƒ³ã‚¯ã‚’å®Ÿéš›ã® Issue ç•ªå·ã«æ›´æ–°
            - æœ€çµ‚æ›´æ–°æ—¥ã‚’ç¾åœ¨æ—¥æ™‚ã«æ›´æ–°  
            - ROADMAP-Project åŒæœŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã‚‹è‡ªå‹•æ›´æ–°

            ### ğŸ”— æ›´æ–°ã•ã‚ŒãŸãƒªãƒ³ã‚¯
            - Epic #17: Advanced Security Features  
            - Epic #39: Docker/Kubernetesçµ±åˆ
            - Epic #40: WebSocket Transport & AIçµ±åˆ  
            - Epic #41: ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºæ©Ÿèƒ½

            **Auto-generated by**: [ROADMAP Sync Workflow](.github/workflows/roadmap-sync.yml)" \
              --base develop \
              --head "$branch_name"
          fi

      - name: ğŸ“ˆ Update Repository Topics
        if: github.event.inputs.force_sync == 'true'  
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Repository topics ã‚’ ROADMAP ã«åŸºã¥ã„ã¦æ›´æ–°
          gh api repos/${{ github.repository }}/topics \
            --method PUT \
            --field names='["rust","wordpress","mcp","model-context-protocol","ai-integration","security","docker","kubernetes","websocket","enterprise","roadmap-managed"]'
