name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]  # developãƒ–ãƒ©ãƒ³ãƒã¸ã®PRã‚‚å«ã‚ã‚‹

# åŒã˜ã‚³ãƒŸãƒƒãƒˆã«å¯¾ã™ã‚‹é‡è¤‡å®Ÿè¡Œã‚’å–ã‚Šæ¶ˆã—
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        rust:
          - stable
          # beta ã¨ nightly ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ã—ã¦é«˜é€ŸåŒ–
          # - beta  
          # - nightly
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ matrix.rust }}
        components: rustfmt, clippy
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Check formatting
      if: matrix.rust == 'stable'
      run: cargo fmt --all -- --check
    
    - name: Run clippy
      if: matrix.rust == 'stable'
      run: cargo clippy --all-targets --all-features -- -D warnings -A dead_code
      
    # PRç”¨ã®è©³ç´°ãªClippyãƒ¬ãƒãƒ¼ãƒˆ
    - name: Generate clippy report for PR
      if: matrix.rust == 'stable' && github.event_name == 'pull_request'
      run: |
        cargo clippy --all-targets --all-features --message-format=json -- -D warnings -A dead_code > clippy-report.json || true
        echo "### ğŸ“‹ Clippy Analysis Results" >> $GITHUB_STEP_SUMMARY
        if [ -s clippy-report.json ]; then
          echo "âœ… All Clippy checks passed!" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Clippy issues found. Please review the logs above." >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Build
      run: cargo build --verbose
    
    - name: Run tests
      run: cargo test --verbose
    
    - name: Build examples
      run: cargo build --examples --verbose

    # PowerShellãƒ†ã‚¹ãƒˆï¼ˆWindowsç’°å¢ƒã®ã¿ï¼‰
    - name: Run PowerShell integration tests
      if: runner.os == 'Windows' && matrix.rust == 'stable'
      shell: powershell
      run: |
        Write-Host "ğŸ”§ Setting up PowerShell test environment..."
        
        # ã‚µãƒ¼ãƒãƒ¼ã‚’ãƒ“ãƒ«ãƒ‰
        cargo build --release --verbose
        
        # ãƒ†ã‚¹ãƒˆè¨­å®šã®æº–å‚™
        if (Test-Path "configs/production/main.toml") {
            $configPath = "configs/production/main.toml"
        } elseif (Test-Path "configs/development/http-transport.toml") {
            $configPath = "configs/development/http-transport.toml" 
        } else {
            Write-Host "âŒ No config file found for testing"
            exit 1
        }
        
        Write-Host "ğŸ“ Using config: $configPath"
        
        # PowerShellãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆCIç”¨ã®ç°¡æ˜“ç‰ˆï¼‰
        try {
            Push-Location tests
            Write-Host "ğŸ§ª Running PowerShell test suite..."
            
            # STDIO Transport ãƒ†ã‚¹ãƒˆï¼ˆCIç’°å¢ƒã§ã‚‚å‹•ä½œï¼‰
            if (Test-Path "transport\test-stdio.ps1") {
                Write-Host "ğŸ“¡ Testing STDIO transport..."
                & ".\transport\test-stdio.ps1" -ConfigPath "..\$configPath"
                if ($LASTEXITCODE -ne 0) {
                    Write-Host "âŒ STDIO test failed"
                    exit 1
                }
            }
            
            Write-Host "âœ… PowerShell tests completed successfully"
        } catch {
            Write-Host "âŒ PowerShell test error: $($_.Exception.Message)"
            exit 1
        } finally {
            Pop-Location
            # ãƒ—ãƒ­ã‚»ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            Get-Process -Name "mcp-rs" -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue
        }

    # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼ï¼ˆå…¨OSï¼‰
    - name: Validate configuration files
      if: matrix.rust == 'stable'
      run: |
        echo "ğŸ” Validating configuration files..."
        
        # configs/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã®æ¤œè¨¼
        for config in configs/production/*.toml configs/development/*.toml; do
          if [ -f "$config" ]; then
            echo "âœ“ Found config: $config"
            
            # TOMLæ§‹æ–‡ã®åŸºæœ¬ãƒã‚§ãƒƒã‚¯ï¼ˆcargoãŒtomlãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æŒã£ã¦ã„ã‚‹ãŸã‚ä½¿ç”¨å¯èƒ½ï¼‰
            if ! cargo run --bin mcp-rs -- --config "$config" --validate-config-only 2>/dev/null; then
              echo "âš ï¸  Config validation skipped for $config (validation feature not available)"
            fi
          fi
        done
        
        echo "âœ… Configuration validation completed"

  security:
    name: Security audit
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    - name: Install cargo-audit
      run: cargo install cargo-audit
    - name: Run cargo audit
      run: cargo audit --ignore RUSTSEC-2023-0071
      # RUSTSEC-2023-0071: RSAè„†å¼±æ€§ã‚’ç„¡è¦–
      # ç†ç”±: sqlx-mysqlçµŒç”±ã®æœªä½¿ç”¨ä¾å­˜é–¢ä¿‚ã®ãŸã‚å½±éŸ¿ãªã—
      # mysql_asyncã‚’ä½¿ç”¨ã—ã¦MySQLæ©Ÿèƒ½ã‚’å®‰å…¨ã«å®Ÿè£…æ¸ˆã¿