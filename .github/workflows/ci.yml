name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]  # developãƒ–ãƒ©ãƒ³ãƒã¸ã®PRã‚‚å«ã‚ã‚‹

# åŒã˜ã‚³ãƒŸãƒƒãƒˆã«å¯¾ã™ã‚‹é‡è¤‡å®Ÿè¡Œã‚’å–ã‚Šæ¶ˆã—
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  # Limit parallelism to prevent resource exhaustion
  CARGO_BUILD_JOBS: 1
  # Reduce memory usage and disable LTO for CI
  CARGO_BUILD_TARGET_DIR: target
  CARGO_NET_RETRY: 2

jobs:
  test:
    name: Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        rust:
          - stable
          # beta ã¨ nightly ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ã—ã¦é«˜é€ŸåŒ–
          # - beta
          # - nightly
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ matrix.rust }}
        components: rustfmt, clippy

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

    - name: Check formatting
      if: matrix.rust == 'stable'
      run: cargo fmt --all -- --check

    - name: Run clippy
      if: matrix.rust == 'stable'
      # Limit clippy to the library target to avoid compiling examples on the runner
      run: cargo clippy --lib --all-features -- -D warnings -A dead_code

    # PRç”¨ã®è©³ç´°ãªClippyãƒ¬ãƒãƒ¼ãƒˆ
    - name: Generate clippy report for PR
      if: matrix.rust == 'stable' && github.event_name == 'pull_request'
      shell: bash
      run: |
        # Run clippy only for the library to avoid building examples in PR analysis
        cargo clippy --lib --all-features --message-format=json -- -D warnings -A dead_code > clippy-report.json || true
        echo "### ğŸ“‹ Clippy Analysis Results" >> $GITHUB_STEP_SUMMARY
        if [ -s clippy-report.json ]; then
          echo "âœ… All Clippy checks passed!" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Clippy issues found. Please review the logs above." >> $GITHUB_STEP_SUMMARY
        fi

    - name: Build
      # Build only the library to avoid compiling examples on the runner (saves disk/memory)
      env:
        CARGO_PROFILE_DEV_LTO: false
        CARGO_PROFILE_TEST_LTO: false
      run: cargo build --lib --verbose --jobs 1

    - name: Run unit tests
      # Test library code with MFA features enabled
      env:
        CARGO_PROFILE_TEST_LTO: false
      run: |
        echo "Running library unit tests with MFA features..."
        cargo test --lib --verbose --features "security,session-management,websocket,mfa" --jobs 1

    - name: Run MFA integration tests
      if: matrix.rust == 'stable'
      env:
        CARGO_PROFILE_TEST_LTO: false
      run: |
        echo "Running MFA integration tests..."
        cargo test --test mfa_integration_tests --features mfa --verbose --jobs 1

    - name: Run MFA performance tests
      if: matrix.rust == 'stable'
      env:
        CARGO_PROFILE_TEST_LTO: false
      run: |
        echo "Running MFA performance tests..."
        cargo test --test mfa_performance_tests --features mfa --verbose --jobs 1

    - name: Verify library compilation
      run: |
        echo "Verifying core library functionality..."
        cargo check --lib --all-features
        echo "Library verification completed"

    # PowerShellãƒ†ã‚¹ãƒˆï¼ˆWindowsç’°å¢ƒã®ã¿ï¼‰- ç°¡ç´ åŒ–ç‰ˆ
    - name: Run PowerShell integration tests
      if: runner.os == 'Windows' && matrix.rust == 'stable'
      shell: powershell
      run: |
        Write-Host "Setting up PowerShell test environment..."

        # ã‚µãƒ¼ãƒãƒ¼ã‚’ãƒ“ãƒ«ãƒ‰ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã¿ï¼‰
        cargo build --lib --release --verbose

        # ãƒ†ã‚¹ãƒˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        $configFound = $false
        $configPath = ""

        if (Test-Path "configs/production/main.toml") {
            $configPath = "configs/production/main.toml"
            $configFound = $true
        }
        if (Test-Path "configs/development/http-transport.toml") {
            $configPath = "configs/development/http-transport.toml"
            $configFound = $true
        }

        if (-not $configFound) {
            Write-Host "No config file found for testing"
            exit 1
        }

        Write-Host "Using config: $configPath"
        Write-Host "PowerShell environment setup completed successfully"

    # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼ï¼ˆå…¨OSï¼‰
    - name: Validate project configuration
      if: matrix.rust == 'stable'
      shell: bash
      run: |
        echo "Validating configuration files..."

        # configs/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã®æ¤œè¨¼
        config_count=0
        for config in configs/production/*.toml configs/development/*.toml; do
          if [ -f "$config" ]; then
            echo "Found config: $config"
            config_count=$((config_count + 1))

            # TOMLæ§‹æ–‡ã®åŸºæœ¬ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“ç‰ˆ - ãƒ•ãƒ«validationã¯æ™‚é–“ãŒã‹ã‹ã‚‹ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ï¼‰
            if grep -q "^\[" "$config"; then
              echo "Config $config appears to be valid TOML format"
            else
              echo "Warning: Config $config may have format issues"
            fi
          fi
        done

        echo "Configuration validation completed. Found $config_count config files."

  security:
    name: Security audit
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    - name: Install cargo-audit
      run: cargo install cargo-audit
    - name: Run cargo audit
      run: cargo audit --ignore RUSTSEC-2023-0071
      # RUSTSEC-2023-0071: RSAè„†å¼±æ€§ã‚’ç„¡è¦–
      # ç†ç”±: sqlx-mysqlçµŒç”±ã®æœªä½¿ç”¨ä¾å­˜é–¢ä¿‚ã®ãŸã‚å½±éŸ¿ãªã—
      # mysql_asyncã‚’ä½¿ç”¨ã—ã¦MySQLæ©Ÿèƒ½ã‚’å®‰å…¨ã«å®Ÿè£…æ¸ˆã¿
