name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]  # developãƒ–ãƒ©ãƒ³ãƒã¸ã®PRã‚‚å«ã‚ã‚‹

# åŒã˜ã‚³ãƒŸãƒƒãƒˆã«å¯¾ã™ã‚‹é‡è¤‡å®Ÿè¡Œã‚’å–ã‚Šæ¶ˆã—
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  # Limit parallelism to prevent resource exhaustion
  CARGO_BUILD_JOBS: 2

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    env:
      # Reduce memory usage during compilation
      RUSTFLAGS: "-C link-dead-code=no -C debuginfo=1"
    strategy:
      matrix:
        rust:
          - stable
          # beta ã¨ nightly ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ã—ã¦é«˜é€ŸåŒ–
          # - beta  
          # - nightly
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ matrix.rust }}
        components: rustfmt, clippy
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Check formatting
      if: matrix.rust == 'stable'
      run: cargo fmt --all -- --check
    
    - name: Run clippy
      if: matrix.rust == 'stable'
      run: cargo clippy --all-targets --all-features -- -D warnings -A dead_code
      
    # PRç”¨ã®è©³ç´°ãªClippyãƒ¬ãƒãƒ¼ãƒˆ
    - name: Generate clippy report for PR
      if: matrix.rust == 'stable' && github.event_name == 'pull_request'
      run: |
        cargo clippy --all-targets --all-features --message-format=json -- -D warnings -A dead_code > clippy-report.json || true
        echo "### ğŸ“‹ Clippy Analysis Results" >> $GITHUB_STEP_SUMMARY
        if [ -s clippy-report.json ]; then
          echo "âœ… All Clippy checks passed!" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Clippy issues found. Please review the logs above." >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Build
      run: cargo build --verbose
    
    - name: Run tests
      run: cargo test --verbose
      
    - name: Verify library compilation
      run: |
        echo "Verifying core library functionality..."
        cargo check --lib --all-features
        echo "Library verification completed"

  security:
    name: Security audit
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    - name: Install cargo-audit
      run: cargo install cargo-audit
    - name: Run cargo audit
      run: cargo audit --ignore RUSTSEC-2023-0071
      # RUSTSEC-2023-0071: RSAè„†å¼±æ€§ã‚’ç„¡è¦–
      # ç†ç”±: sqlx-mysqlçµŒç”±ã®æœªä½¿ç”¨ä¾å­˜é–¢ä¿‚ã®ãŸã‚å½±éŸ¿ãªã—
      # mysql_asyncã‚’ä½¿ç”¨ã—ã¦MySQLæ©Ÿèƒ½ã‚’å®‰å…¨ã«å®Ÿè£…æ¸ˆã¿